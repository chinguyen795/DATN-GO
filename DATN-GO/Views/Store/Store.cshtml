@model List<DATN_GO.ViewModels.Store.StoreViewModel>


@{
    ViewData["Title"] = "Store Page";
}


<style>
    .rating-filter.active,
    .orders-filter.active {
        background-color: #dc3545 !important;
        color: white !important;
        border-color: #dc3545 !important;
    }

    .filter-btn-hover.active {
        background-color: white !important;
        color: #dc3545 !important;
    }

</style>

<!-- Filter bar -->
<div class="bg-crimson rounded-3 mt-3 mb-3 py-3">
    <div class="d-flex flex-row align-items-center justify-content-between flex-wrap mx-2">
        <div class="text-white fw-bold me-2 my-auto">
            <button class="btn btn-outline-light d-lg-none me-2" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#filterOffcanvas">
                <i class="bi bi-funnel"></i> Bộ lọc
            </button>
            <span>Sắp xếp theo:</span>
        </div>
        <div class="d-flex flex-row gap-2 flex-wrap">
            <button class="btn text-white fw-bold border border-white filter-btn-hover"
                    data-value="rating-desc">
                <i class="bi bi-star-fill me-1"></i>
                <span>Đánh giá cao nhất</span>
            </button>
            <button class="btn text-white fw-bold border border-white filter-btn-hover"
                    data-value="orders-desc">
                <i class="bi bi-bag-check me-1"></i>
                <span>Đơn hàng nhiều nhất</span>
            </button>
            <button class="btn text-white fw-bold border border-white filter-btn-hover" data-value="newest">
                <i class="bi bi-clock-history me-1"></i>
                <span>Mới nhất</span>
            </button>
        </div>
    </div>
</div>

<!-- Mobile Filter Offcanvas -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="filterOffcanvas">
    <div class="offcanvas-header text-crimson bg-light mx-0">
        <h5 class="offcanvas-title fw-bold">Bộ lọc</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div class="filter-section">
            <!-- Search -->
            <div class="mb-3">
                <label for="searchInputMobile" class="form-label">
                    <i class="bi bi-search"></i> Tìm kiếm
                </label>
                <input type="text" id="searchInputMobile" class="form-control"
                       placeholder="Tìm theo tên cửa hàng..." />
            </div>
            <!-- Province Filter -->
            <div class="mb-3">
                <label class="form-label">
                    <i class="bi bi-geo-alt"></i> Tỉnh/Thành phố
                </label>
                <select class="form-select" id="provinceFilterMobile">
                    <option value="">Tất cả tỉnh/thành</option>
                    <option value="can-tho">Cần Thơ</option>
                    <option value="hcm">TP. Hồ Chí Minh</option>
                    <option value="ha-noi">Hà Nội</option>
                    <option value="da-nang">Đà Nẵng</option>
                    <option value="an-giang">An Giang</option>
                    <option value="bac-lieu">Bạc Liêu</option>
                    <option value="kien-giang">Kiên Giang</option>
                    <option value="ca-mau">Cà Mau</option>
                    <option value="tien-giang">Tiền Giang</option>
                    <option value="long-an">Long An</option>
                    <option value="dong-thap">Đồng Tháp</option>
                </select>
            </div>

            <!-- Apply Filters Button -->
            <button class="btn btn-crimson w-100" data-bs-dismiss="offcanvas">
                <i class="bi bi-funnel"></i> Áp dụng bộ lọc
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-3 col-md-12">
        <!-- Store Filter -->
        <h5 class="mb-3">Lọc cửa hàng</h5>

        <!-- Search Filter -->
        <form method="get" asp-action="Store" asp-controller="Store" id="searchForm">
            <div class="mb-3 d-flex">
                <input type="text" class="form-control" name="search" id="searchInput"
                       value="@ViewBag.Search" placeholder="Tìm theo tên cửa hàng..." autocomplete="off" />
                <button type="submit" class="btn btn-crimson ms-2" id="searchBtn">
                    <i class="bi bi-search"></i>
                </button>
            </div>
        </form>

        <!-- Province Filter -->
        <div class="mb-3">
            <label for="provinceSelect" class="form-label">
                <i class="bi bi-geo-alt-fill me-1 text-crimson"></i> Tỉnh/Thành phố
            </label>
            <select class="form-select"
                    id="provinceSelect"
                    data-live-search="true"
                    data-style="btn-outline-crimson"
                    data-width="100%">
                <option value="">Tất cả địa điểm</option>
                <option value="can-tho">Cần Thơ</option>
                <option value="hcm">TP. Hồ Chí Minh</option>
                <option value="ha-noi">Hà Nội</option>
                <option value="da-nang">Đà Nẵng</option>
                <option value="other">Tỉnh/TP khác</option>
            </select>
        </div>

        <!-- Rating Filter -->
        <div class="mb-3">
            <label class="form-label">
                <i class="bi bi-star"></i> Đánh giá
            </label>
            <div class="d-grid gap-2">
                <button class="btn btn-outline-danger rating-filter" type="button" data-rating="4.5">
                    Từ 4.5 <i class="bi bi-star-fill"></i>
                </button>
                <button class="btn btn-outline-danger rating-filter" type="button" data-rating="4.0">
                    Từ 4.0 <i class="bi bi-star-fill"></i>
                </button>
                <button class="btn btn-outline-danger rating-filter" type="button" data-rating="3.5">
                    Từ 3.5 <i class="bi bi-star-fill"></i>
                </button>
            </div>
        </div>

        <!-- Orders Filter -->
        <div class="mb-3">
            <label class="form-label">
                <i class="bi bi-cart-check"></i> Lượt đặt hàng
            </label>
            <div class="d-grid gap-2">
                <button class="btn btn-outline-danger orders-filter" type="button" data-orders="10000"
                        onclick="toggleOrdersFilter(this)">
                    Trên 10k <i class="bi bi-cart-check-fill text-danger ms-1"></i>
                </button>
                <button class="btn btn-outline-danger orders-filter" type="button" data-orders="5000"
                        onclick="toggleOrdersFilter(this)">
                    Trên 5k <i class="bi bi-cart-check-fill text-danger ms-1"></i>
                </button>
                <button class="btn btn-outline-danger orders-filter" type="button" data-orders="1"
                        onclick="toggleOrdersFilter(this)">
                    Dưới 5k <i class="bi bi-cart-check-fill text-danger ms-1"></i>
                </button>
            </div>
        </div>

        <button class="btn btn-crimson w-100 mb-2" onclick="applyFilters()" style="text-transform: capitalize;">
            <i class="bi bi-search"></i> Tìm kiếm
        </button>
        <!-- End of Store Filter -->
    </div>
    <!-- Card 9 -->
    <div class="col-lg-9 col-md-12">
        <div class="row">
            @foreach (var store in Model)
            {
                var quantity = store.TotalProductQuantity;
                var cartQuantity = store.TotalSoldProducts;
                var statusKey = store.Status switch
                {
                    StoreStatus.Active => "active",
                    StoreStatus.Inactive => "inactive",
                    StoreStatus.PendingApproval => "pending",
                    StoreStatus.NotApproved => "not-approved",
                    StoreStatus.Rejected => "rejected",
                    _ => "unknown"
                };

                var statusClass = store.Status switch
                {
                    StoreStatus.Active => "bg-success",
                    StoreStatus.Inactive => "bg-crimson",
                    StoreStatus.PendingApproval => "bg-warning",
                    StoreStatus.NotApproved => "bg-secondary",
                    StoreStatus.Rejected => "bg-dark",
                    _ => "bg-secondary"
                };

                string statusText = store.Status switch
                {
                    StoreStatus.Active => "Hoạt động",
                    StoreStatus.Inactive => "Ngừng hoạt động",
                    StoreStatus.PendingApproval => "Chờ duyệt",
                    StoreStatus.NotApproved => "Chưa duyệt",
                    StoreStatus.Rejected => "Từ chối",
                    _ => "Không rõ"
                };

                <div class="col-lg-4 col-md-6 col-sm-6 mb-3 store-wrapper">
                    <div class="store-card card h-100 border rounded shadow hover-scale"
                         data-name="@store.Name?.ToLower()"
                         data-address="@store.Address?.ToLower()"
                         data-status="@statusText.ToLower()"
                         data-status-key="@statusKey"
                         data-rating="@store.AverageRating.ToString("0.0")"
                         data-quantity="@quantity"
                         data-cart="@cartQuantity"
                         data-created-at="@store.CreateAt.ToString("yyyy-MM-ddTHH:mm:ss")">
                        <a href="@Url.Action("Detail", "Store", new { id = store.Id })" class="text-decoration-none text-dark">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-4 align-items-center pt-2">
                                        <img src="@store.Avatar" alt="@store.Name" height="70" width="70"
                                             class="rounded-circle object-fit-cover border"
                                             data-bs-toggle="tooltip" title="@store.Name" />
                                    </div>
                                    <div class="col-8">
                                        <h5 class="fw-bold text-truncate"
                                            data-bs-toggle="tooltip" title="@store.Name">
                                            @store.Name
                                        </h5>
                                        <div class="d-flex align-items-center mb-1"
                                             data-bs-toggle="tooltip" title="@store.Province">
                                            <i class="bi bi-geo-alt text-crimson me-1"></i>
                                            <p class="text-truncate mb-0 small">@store.Province</p>
                                        </div>
                                        <div class="d-flex align-items-center mb-2"
                                             data-bs-toggle="tooltip" title="@statusText">
                                            <i class="bi bi-shop text-crimson me-1"></i>
                                            <span class="badge @statusClass ms-2">@statusText</span>
                                        </div>
                                        <div class="row text-nowrap align-items-center gx-2">
                                            <!-- Rating -->
                                            <div class="col d-flex align-items-center"
                                                 data-bs-toggle="tooltip" title="Đánh giá: @store.AverageRating.ToString("0.0") (@store.ReviewCount lượt)">
                                                <span class="fw-bold">@store.AverageRating.ToString("0.0")</span>
                                                <i class="bi bi-star-fill text-crimson ms-1"></i>
                                                <small class="text-muted ms-1">(@store.ReviewCount)</small>
                                            </div>
                                            <!-- Orders -->
                                            <div class="col d-flex align-items-center justify-content-center"
                                                 data-bs-toggle="tooltip" title="Đã bán: @store.TotalSoldProducts sản phẩm">
                                                <span>@store.TotalSoldProducts</span>
                                                <i class="bi bi-bag-check-fill text-crimson ms-1"></i>
                                            </div>
                                            <!-- Products -->
                                            <div class="col d-flex align-items-center justify-content-end"
                                                 data-bs-toggle="tooltip" title="Tổng sản phẩm: @store.TotalProductQuantity">
                                                <span>@store.TotalProductQuantity</span>
                                                <i class="bi bi-box-fill text-crimson ms-1"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                        <div class="card-footer bg-white border-top-0 d-flex justify-content-between align-items-center p-3">
                            <a href="@Url.Action("Detail", "Store", new { id = store.Id })"
                               class="btn btn-crimson flex-grow-1"
                               style="text-transform: capitalize;"
                               data-bs-toggle="tooltip" title="Xem chi tiết cửa hàng @store.Name">
                                <i class="bi bi-shop me-2"></i>Xem cửa hàng
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    window.addEventListener("DOMContentLoaded", () => {
        const toastMessage = '@TempData["ToastMessage"]';
        const toastType = '@TempData["ToastType"]';

        if (toastMessage && toastType === "warning") {
            setTimeout(() => {
                location.reload();
            }, 1000);
        }
    });
    $(document).ready(function () {
        const $input = $('#searchInput');
        const $form = $('#searchForm');
        let currentSort = "";
        let lastValue = $input.val().trim();

        // 🔧 Hàm loại bỏ dấu tiếng Việt để lọc tỉnh thành
        function removeDiacritics(str) {
            return str.normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/đ/g, "d")
                .replace(/Đ/g, "D");
        }

        // 🔍 Khi người dùng gõ trong input
        $input.on('input', function () {
            const keyword = $input.val().trim();

            const selectedProvince = $('#provinceSelect').val()?.toLowerCase();
            const selectedRating = $('.rating-filter.active').data('rating');
            const selectedOrders = $('.orders-filter.active').data('orders');
            const selectedStatus = $('#statusFilter').val()?.toLowerCase();

            const noFilter =
                (!selectedProvince || selectedProvince === "tất cả địa điểm") &&
                !selectedRating &&
                !selectedOrders &&
                (!selectedStatus || selectedStatus === "") &&
                (!currentSort || currentSort === "");

            if (lastValue !== '' && keyword === '' && noFilter) {
                $form.length ? $form.submit() : window.location.reload();
                return;
            }

            lastValue = keyword;
        });

        // ⭐ Toggle đánh giá
        $('.rating-filter').on('click', function () {
            $(this).toggleClass('active').siblings().removeClass('active');
        });

        // 🛒 Toggle đơn hàng
        $('.orders-filter').on('click', function () {
            $(this).toggleClass('active').siblings().removeClass('active');
        });

        // 🔀 Toggle sắp xếp
        $('.filter-btn-hover').on('click', function () {
            const $btn = $(this);
            const value = $btn.data('value');

            if (currentSort === value) {
                currentSort = "";
                $btn.removeClass('active');
            } else {
                currentSort = value;
                $('.filter-btn-hover').removeClass('active');
                $btn.addClass('active');
            }

            applyFilters();
        });

        // 🧭 Lọc lại khi đổi trạng thái
        $('#statusFilter').on('change', function () {
            applyFilters();
        });

        // 🌍 Lọc lại khi đổi tỉnh thành
        $('#provinceSelect').on('change', function () {
            applyFilters();
        });

        // 🔥 Lọc & Sắp xếp
        window.applyFilters = function () {
            const selectedProvince = $('#provinceSelect').val()?.toLowerCase();
            const selectedRating = $('.rating-filter.active').data('rating');
            const selectedOrders = $('.orders-filter.active').data('orders');
            const selectedStatus = $('#statusFilter').val()?.toLowerCase();
            const keyword = $('#searchInput').val()?.toLowerCase();

            const $allWrappers = $('.store-wrapper');
            const $allCards = $allWrappers.find('.store-card');

            const noFilter =
                (!selectedProvince || selectedProvince === "tất cả địa điểm") &&
                !selectedRating &&
                !selectedOrders &&
                (!selectedStatus || selectedStatus === "") &&
                (!keyword || keyword === "") &&
                (!currentSort || currentSort === "");

            if (noFilter) {
                window.location.reload();
                return;
            }

            $allWrappers.hide();

            const $matchedCards = $allCards.filter(function () {
                const $card = $(this);
                const address = ($card.data('address') || '').toLowerCase();
                const normalizedAddress = removeDiacritics(address);

                const rating = parseFloat($card.data('rating')) || 0;
                const cart = parseInt($card.data('cart')) || 0;
                const statusKey = ($card.data('status-key') || '').toLowerCase();
                const textContent = $card.text().toLowerCase();

                let match = true;
                if (selectedProvince && !normalizedAddress.includes(selectedProvince)) match = false;
                if (selectedRating && rating < selectedRating) match = false;
                if (selectedOrders && cart < selectedOrders) match = false;
                if (selectedStatus && statusKey !== selectedStatus) match = false;
                if (keyword && !textContent.includes(keyword)) match = false;

                return match;
            });

            const sorted = $matchedCards.closest('.store-wrapper').sort(function (a, b) {
                const $a = $(a).find('.store-card');
                const $b = $(b).find('.store-card');

                if (currentSort === "rating-desc") {
                    return parseFloat($b.data('rating')) - parseFloat($a.data('rating'));
                }

                if (currentSort === "orders-desc") {
                    return parseInt($b.data('cart')) - parseInt($a.data('cart'));
                }

                // Sắp xếp theo trạng thái
                const selectedStatus = $('#statusFilter').val()?.toLowerCase();
                if (selectedStatus === "đang hoạt động") {
                    const aStatus = ($a.data('status-key') || '').toLowerCase();
                    const bStatus = ($b.data('status-key') || '').toLowerCase();
                    if (aStatus === "active" && bStatus !== "active") return -1;
                    if (aStatus !== "active" && bStatus === "active") return 1;
                }

                if (selectedStatus === "ngừng hoạt động") {
                    const aStatus = ($a.data('status-key') || '').toLowerCase();
                    const bStatus = ($b.data('status-key') || '').toLowerCase();
                    if (aStatus === "inactive" && bStatus !== "inactive") return -1;
                    if (aStatus !== "inactive" && bStatus === "inactive") return 1;
                }

                // 🕒 Sắp xếp theo ngày tạo nếu có
                if (currentSort === "newest") {
                    const aDate = new Date($a.data('created-at'));
                    const bDate = new Date($b.data('created-at'));
                    return bDate - aDate;
                }

                return 0;
            });

            sorted.show().each(function () {
                $(this).parent().append(this);
            });

    $('.rating-filter, .orders-filter').on('mouseleave', function (e) {
        // Nếu vẫn còn di chuột sang 1 nút filter khác => bỏ qua
        if ($(e.relatedTarget).closest('.rating-filter, .orders-filter').length) return;

        const hasActive =
            $('.rating-filter.active').length > 0 ||
            $('.orders-filter.active').length > 0;

        if (!hasActive) {
            // Cho 1 nhịp ngắn để tránh giật (optional)
            setTimeout(() => { location.reload(); }, 100);
        }
    });


    function reloadIfNoActiveFilters() {
        const hasActive =
            $('.rating-filter.active').length > 0 ||
            $('.orders-filter.active').length > 0;

        if (!hasActive) {
            setTimeout(() => { location.reload(); }, 100);
        }
    }

    // Hook vào click sẵn có
    $('.rating-filter').on('click', function () {
        // code cũ của bạn đã toggle active rồi, mình chỉ gọi check thêm
        reloadIfNoActiveFilters();
    });
    $('.orders-filter').on('click', function () {
        // code cũ của bạn đã toggle active rồi, mình chỉ gọi check thêm
        reloadIfNoActiveFilters();
    });

        };
    });
</script>