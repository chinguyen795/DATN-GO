@model DATN_GO.ViewModels.Orders.OrderDetailVM
@{
    ViewData["Title"] = "Chi tiết đơn hàng";
    var itemsTotal = Model.ItemsTotal;     // hoặc Model.Items.Sum(x => x.SubTotal)
    var ship = Model.DeliveryFee;
    var discount = Model.VoucherReduce;  // giá trị âm sẽ hiển thị có dấu "–" ở dòng voucher
    var grandTotal = Model.TotalPrice > 0
        ? Model.TotalPrice
        : itemsTotal + ship - discount;
    var crimson = ViewBag.Crimson as string ?? "#dc143c";
    var items = Model?.Items ?? new List<DATN_GO.ViewModels.Orders.OrderDetailItemVM>();
}

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">

            <div class="d-flex align-items-center mb-3">
                <div class="rounded-circle d-inline-flex justify-content-center align-items-center me-2"
                     style="width:42px;height:42px;background:@crimson;">
                    <i class="bi bi-receipt text-white fs-5"></i>
                </div>
                <h4 class="m-0">Đơn hàng #@Model.OrderId</h4>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="small text-muted">Ngày đặt</div>
                            <div class="fw-semibold">@Model.OrderDate.ToString("dd/MM/yyyy HH:mm")</div>
                        </div>
                        <div class="col-md-3">
                            <div class="small text-muted">Trạng thái</div>
                            <span class="badge" style="background:@crimson">@Model.Status</span>
                        </div>
                        <div class="col-md-3">
                            <div class="small text-muted">Thanh toán</div>
                            <div class="fw-semibold">@Model.PaymentMethod (@Model.PaymentStatus)</div>
                        </div>
                        <div class="col-md-3">
                            <div class="small text-muted">Vận chuyển</div>
                            <div class="fw-semibold">
                                @Model.ShippingMethodName
                                @if (!string.IsNullOrWhiteSpace(Model.LabelId))
                                {
                                    <span class="text-muted ms-2">(Mã vận đơn: @Model.LabelId)</span>
                                }
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white fw-semibold">Sản phẩm</div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Sản phẩm</th>
                                    <th class="text-center" style="width:120px;">SL</th>
                                    <th class="text-end" style="width:160px;">Đơn giá</th>
                                    <th class="text-end" style="width:160px;">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (!items.Any())
                                {
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">Không có sản phẩm.</td>
                                    </tr>
                                }
                                else
                                {
                                    foreach (var it in items)
                                    {
                                        var img = string.IsNullOrWhiteSpace(it.Image) ? "/images/placeholder.png" : it.Image;
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <img src="@img" class="rounded me-3" style="width:56px;height:56px;object-fit:cover" />
                                                    <div>@it.ProductName</div>
                                                </div>
                                            </td>
                                            <td class="text-center">@it.Quantity</td>
                                            <td class="text-end">@it.Price.ToString("N0") đ</td>
                                            <td class="text-end">@it.SubTotal.ToString("N0") đ</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" class="text-end fw-semibold">Tạm tính</td>
                                    <td class="text-end fw-semibold">@Model.ItemsTotal.ToString("N0") đ</td>
                                </tr>
                                <tr>
                                    <td colspan="3" class="text-end">Phí vận chuyển</td>
                                    <td class="text-end">@Model.DeliveryFee.ToString("N0") đ</td>
                                </tr>
                                <tr>
                                    <td colspan="3" class="text-end">
                                        Voucher giảm giá
                                        @if (!string.IsNullOrWhiteSpace(Model.VoucherName))
                                        {
                                            <span class="text-muted ms-1">(@Model.VoucherName)</span>
                                        }
                                    </td>
                                    <td class="text-end">-@Model.VoucherReduce.ToString("N0") đ</td>
                                </tr>

                                <tr>
                                    <td colspan="3" class="text-end"><strong>Tổng cộng</strong></td>
                                    <td class="text-end"><strong>@grandTotal.ToString("N0") đ</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2">
                <a class="btn text-white" style="background:@crimson;border-color:@crimson"
                   asp-controller="Home" asp-action="Index">
                    <i class="bi bi-house-door me-1"></i> Về trang chủ
                </a>
                <a class="btn" style="border:1px solid @crimson;color:@crimson"
                   asp-controller="Profile" asp-action="Index">
                    <i class="bi bi-person-circle me-1"></i> Tài khoản của tôi
                </a>
            </div>

        </div>
    </div>
</div>