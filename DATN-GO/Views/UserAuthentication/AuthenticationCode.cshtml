@{
    ViewData["Title"] = "AuthenticationCode Page";
    var identifier = ViewBag.Identifier as string;
}
<section class="py-5 bg-light min-vh-100 d-flex align-items-center">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-6 col-md-8">
                <div class="bg-white p-4 p-md-5 rounded shadow-sm">
                    <div class="text-center mb-4">
                        <i class="bi bi-shield-lock text-danger display-1"></i>
                        <h4 class="text-danger mt-3">Xác nhận mã OTP</h4>
                        <p class="text-muted">
                            <span>Mã xác nhận đã được gửi đến <strong class="text-danger">@identifier</strong></span>
                        </p>
                    </div>

                    <form method="post" asp-action="AuthenticationCode" asp-controller="UserAuthentication" id="verifyOtpForm">
                        <input type="hidden" name="identifier" value="@identifier" />
                        <input type="hidden" id="otpCombinedCode" name="code" />

                        <div class="otp-inputs d-flex justify-content-center gap-2 gap-md-3 mb-4">
                            @for (int i = 1; i <= 6; i++)
                            {
                                <input type="text" class="form-control text-center otp-input" maxlength="1" data-index="@i" />
                            }
                        </div>

                        <div class="d-grid">
                            <button class="btn btn-danger" type="submit" id="verifyBtn">
                                <i class="bi bi-check-circle me-2"></i>Xác nhận
                            </button>
                        </div>
                    </form>

                    <div class="text-center mb-4 mt-3">
                        <p class="text-muted mb-0">
                            Không nhận được mã?
                            <form method="post" asp-action="ResendAuthenticationCode" asp-controller="UserAuthentication" id="resendOtpForm">
                                <input type="hidden" name="identifier" value="@identifier" />
                                <button type="submit" class="btn btn-link text-danger p-0 border-0" id="resendBtn">Gửi lại</button>
                            </form>
                        </p>
                        <div id="countdown" class="text-muted small"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let timeLeft = 60;
            let countdownInterval;

            const inputs = document.querySelectorAll('.otp-input'); // Các ô input nhỏ (1 ký tự)
            const resendBtn = document.getElementById('resendBtn');
            const countdownSpan = document.getElementById('countdown');

            const verifyOtpForm = document.getElementById('verifyOtpForm');
            const otpCombinedCodeInput = document.getElementById('otpCombinedCode'); // Input ẩn để chứa mã OTP đã nối

            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => { // Dùng 'input' thay vì 'keyup' để bắt các trường hợp paste
                    input.value = input.value.replace(/\D/g, '').slice(0, 1);

                    if (input.value.length === 1 && index < inputs.length - 1) {
                        inputs[index + 1].focus(); // Tự động chuyển focus
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && input.value === '' && index > 0) {
                        inputs[index - 1].focus(); // Quay lại ô trước
                    }
                });
            });

            // Xử lý khi form xác nhận OTP được submit
            verifyOtpForm.addEventListener('submit', function (e) {
                let otpCode = '';
                inputs.forEach(input => {
                    otpCode += input.value; // Nối các ký tự lại thành chuỗi OTP
                });

                console.log('OTP Code collected from inputs (JS):', otpCode); // DEBUG: Kiểm tra giá trị đã nối

                if (otpCode.length !== inputs.length) { // inputs.length là 6
                    e.preventDefault(); // Ngăn form gửi đi
                    alert('Vui lòng nhập đầy đủ 6 chữ số mã OTP.');
                    return false;
                }

                otpCombinedCodeInput.value = otpCode;
                console.log('Value assigned to hidden otpCombinedCodeInput (JS):', otpCombinedCodeInput.value); // DEBUG: Kiểm tra giá trị sau khi gán
            });

           
            resendBtn.addEventListener('click', () => {
                timeLeft = 60; // Reset thời gian
                resendBtn.disabled = true;
                if (countdownInterval) clearInterval(countdownInterval);
                countdownInterval = setInterval(updateCountdown, 1000);

            });

           
            countdownInterval = setInterval(updateCountdown, 1000);

            function updateCountdown() {
                if (timeLeft > 0) {
                    timeLeft--;
                    countdownSpan.textContent = `Vui lòng chờ ${timeLeft} giây.`;
                } else {
                    clearInterval(countdownInterval);
                    resendBtn.disabled = false;
                    countdownSpan.textContent = ''; // Xóa thông báo đếm ngược
                }
            }
        });
    </script>
