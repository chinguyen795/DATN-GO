@model DATN_GO.ViewModels.Address.AddressCreateViewModel
@{
    ViewData["Title"] = "THÊM ĐỊA CHỈ MỚI";
}
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />

<div class="container">
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success text-center fade show" id="successMessage" role="alert">
            @TempData["Success"]
        </div>
    }
    @if (ViewBag.ShowDefaultModal == true)
    {
        <script>
            window.addEventListener('DOMContentLoaded', function () {
                var modal = new bootstrap.Modal(document.getElementById('defaultConfirmModalEdit'));
                modal.show();
            });
        </script>
    }

    <div class="row justify-content-center mb-4">
        <div class="col-12 col-md-10 col-lg-10 col-xl-10">

            <div class="card border border-2 rounded-3">

                <div class="card-body">
                    <h3 class="text-center mb-3">@ViewData["Title"]</h3>

                    <div class="mb-4">
                        <a asp-action="Address" class="btn btn-light" style="text-transform: capitalize;">
                            <i class="bi bi-arrow-left"></i> Quay về danh sách
                        </a>
                    </div>

                    <form asp-action="Create" method="post">
                        <input type="hidden" asp-for="UserId" id="UserId" />
                        <span asp-validation-for="UserId" class="text-danger small"></span>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="Name" class="form-label">Tên người nhận</label>
                                <input asp-for="Name" class="form-control" id="Name" placeholder="Nhập tên người nhận..." />
                                <span asp-validation-for="Name" class="text-danger small"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Phone" class="form-label">Số điện thoại</label>
                                <input asp-for="Phone" class="form-control" id="Phone" placeholder="Nhập sđt..." />
                                <span asp-validation-for="Phone" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="Status" class="form-label">Trạng thái</label>
                                <select asp-for="Status" class="form-control" id="Status">
                                    <option value="@((int)AddressStatus.Default)">Mặc định</option>
                                    <option value="@((int)AddressStatus.NotDefault)">Không mặc định</option>
                                </select>
                                <span asp-validation-for="Status" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label asp-for="CityName" class="form-label">Tỉnh / Thành phố</label>
                                <select asp-for="CityName" class="form-control" id="CityName">
                                    <option value="">-- Chọn tỉnh --</option>
                                    @foreach (var city in Model.Cities)
                                    {
                                        <option value="@city.CityName">@city.CityName</option>
                                    }
                                </select>
                                <span asp-validation-for="CityName" class="text-danger small"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="DistrictName" class="form-label">Quận / Huyện</label>
                                <select asp-for="DistrictName" class="form-control" id="DistrictName">
                                    <option value="">-- Chọn huyện --</option>
                                </select>
                                <span asp-validation-for="DistrictName" class="text-danger small"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="WardName" class="form-label">Phường / Xã</label>
                                <select asp-for="WardName" class="form-control" id="WardName">
                                    <option value="">-- Chọn xã --</option>
                                </select>
                                <span asp-validation-for="WardName" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Description" class="form-label">Mô tả</label>
                            <input asp-for="Description" class="form-control" id="Description" placeholder="Nhập mô tả..." />
                            <span asp-validation-for="Description" class="text-danger small"></span>
                        </div>

                        <input type="hidden" asp-for="Latitude" id="Latitude" />
                        <span asp-validation-for="Latitude" class="text-danger small"></span>

                        <input type="hidden" asp-for="Longitude" id="Longitude" />
                        <span asp-validation-for="Longitude" class="text-danger small"></span>

                        <div class="d-flex justify-content-center mt-4">
                            <button id="submitBtn" type="submit" class="btn btn-outline-danger" style="text-transform: capitalize;">
                                <span class="spinner-border spinner-border-sm d-none" id="loadingSpinner" role="status" aria-hidden="true"></span>
                                <span id="btnText"><i class="bi bi-save"></i> Thêm địa chỉ</span>
                            </button>
                        </div>
                    </form>

                </div>
            </div>

            <div id="map" style="height: 400px;" class="mt-4 border border-2 rounded-3"></div>
        </div>
    </div>
</div>

@* Modal xác nhận  *@
<div class="modal fade" id="defaultConfirmModal" tabindex="-1" aria-labelledby="defaultConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-dark">
                <h5 class="modal-title" id="defaultConfirmModalLabel">Xác nhận địa chỉ mặc định</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                Người dùng đã có địa chỉ mặc định: <br />
                <strong>@ViewBag.ExistingDefault</strong> <br /><br />
                Bạn có muốn thay thế bằng địa chỉ mới không?
            </div>
            <div class="modal-footer">
                <form method="post" asp-action="ConfirmReplaceDefault">
                    <input type="hidden" name="confirm" value="true" />
                    <button type="submit" class="btn btn-primary">Có, thay thế</button>
                </form>

                <form method="post" asp-action="ConfirmReplaceDefault">
                    <input type="hidden" name="confirm" value="false" />
                    <button type="submit" class="btn btn-secondary">Không</button>
                </form>
            </div>

        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiaG9hbmdraGFuZzE2MDIiLCJhIjoiY21hYXViNTcyMDdwODJrc2N1bmVwY3h6eiJ9.MgDmLsya34LTrqNPE7WiLw';

    let map, marker;

    function resetDropdown(selector, placeholder) {
        $(selector).html(`<option value="">${placeholder}</option>`);
    }

    function updateMap(lat, lon) {
        if (!map) {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [lon, lat],
                zoom: 15,
                pitch: 45,
                bearing: -30,
                antialias: true
            });

            map.addControl(new mapboxgl.NavigationControl());

            map.on('click', function (e) {
                const clickedLat = e.lngLat.lat;
                const clickedLon = e.lngLat.lng;

                $('#Latitude').val(clickedLat);
                $('#Longitude').val(clickedLon);

                if (marker) marker.remove();
                marker = new mapboxgl.Marker({ color: 'red' }).setLngLat([clickedLon, clickedLat]).addTo(map);

                reverseGeocodeFromMapbox(clickedLat, clickedLon);
            });
        } else {
            map.flyTo({ center: [lon, lat], essential: true });
        }

        if (marker) marker.remove();
        marker = new mapboxgl.Marker({ color: 'red' }).setLngLat([lon, lat]).addTo(map);
    }

    function reverseGeocodeFromMapbox(lat, lon) {
        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lon},${lat}.json?access_token=${mapboxgl.accessToken}`;

        fetch(url)
            .then(res => res.json())
            .then(data => {
                if (!data.features) return;

                let cityName = '', districtName = '', wardName = '';

                data.features.forEach(f => {
                    if (f.place_type.includes('place') && !cityName) cityName = f.text;
                    if (f.place_type.includes('district') && !districtName) districtName = f.text;
                    if ((f.place_type.includes('neighborhood') || f.place_type.includes('locality')) && !wardName) wardName = f.text;
                });

                if (!cityName && !districtName && !wardName) {
                    alert("Không tìm thấy địa chỉ từ Mapbox.");
                    return;
                }

                const locationData = window.locationData;

                const city = locationData.find(c => c.CityName.toLowerCase() === cityName.toLowerCase());
                if (city) {
                    $('#CityName').val(city.CityName).trigger('change');

                    setTimeout(() => {
                        const district = city.Districts.find(d => d.DistrictName.toLowerCase() === districtName.toLowerCase());
                        if (district) {
                            $('#DistrictName').val(district.DistrictName).trigger('change');

                            setTimeout(() => {
                                const ward = district.Wards.find(w => w.WardName.toLowerCase() === wardName.toLowerCase());
                                if (ward) {
                                    $('#WardName').val(ward.WardName);
                                }
                            }, 200);
                        }
                    }, 200);
                }
            })
            .catch(() => alert("Lỗi khi lấy địa chỉ từ Mapbox."));
    }

    $(document).ready(function () {
        $('.text-danger').hide();

        const defaultLat = 10.762622;
        const defaultLon = 106.660172;
        $('#Latitude').val(defaultLat);
        $('#Longitude').val(defaultLon);
        updateMap(defaultLat, defaultLon);

        $.getJSON("/data/locations.json", function (data) {
            window.locationData = data;

            // Đổ tỉnh
            data.forEach(city => {
                $('#CityName').append(`<option value="${city.CityName}">${city.CityName}</option>`);
            });

            // Khi chọn tỉnh
            $('#CityName').on('change', function () {
                const selectedCityName = $(this).val();
                const city = data.find(c => c.CityName === selectedCityName);

                resetDropdown('#DistrictName', '-- Chọn huyện --');
                resetDropdown('#WardName', '-- Chọn xã --');

                if (city?.Districts) {
                    city.Districts.forEach(d => {
                        $('#DistrictName').append(`<option value="${d.DistrictName}">${d.DistrictName}</option>`);
                    });
                }
            });

            // Khi chọn huyện
            $('#DistrictName').on('change', function () {
                const selectedCityName = $('#CityName').val();
                const selectedDistrictName = $(this).val();

                const city = data.find(c => c.CityName === selectedCityName);
                const district = city?.Districts?.find(d => d.DistrictName === selectedDistrictName);

                resetDropdown('#WardName', '-- Chọn xã --');

                if (district?.Wards) {
                    district.Wards.forEach(w => {
                        $('#WardName').append(`<option value="${w.WardName}">${w.WardName}</option>`);
                    });
                }
            });

            // Khi chọn xã thì map lại
            $('#WardName').on('change', function () {
                const wardName = $('#WardName').val();
                const districtName = $('#DistrictName').val();
                const cityName = $('#CityName').val();

                if (wardName && districtName && cityName) {
                    const full = `${wardName}, ${districtName}, ${cityName}`;
                    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(full)}&format=json`;

                    fetch(url)
                        .then(res => res.json())
                        .then(data => {
                            if (data.length > 0) {
                                const lat = parseFloat(data[0].lat);
                                const lon = parseFloat(data[0].lon);
                                $('#Latitude').val(lat);
                                $('#Longitude').val(lon);
                                updateMap(lat, lon);
                            }
                        });
                }
            });
        });

      // Custom validation
        $('#submitBtn').on('click', function (e) {
            let isValid = true;
            $('.text-danger').text('').hide();

            function validateField(id, msg) {
                const value = $(`#${id}`).val()?.trim();
                if (!value) {
                    $(`[data-valmsg-for="${id}"]`).text(msg).show();
                    isValid = false;
                } else {
                    $(`[data-valmsg-for="${id}"]`).hide();
                }
            }

            validateField('Name', 'Vui lòng không bỏ trống tên người nhận');
            validateField('Phone', 'Vui lòng không bỏ trống số điện thoại');
            validateField('Status', 'Vui lòng chọn trạng thái');
            validateField('CityName', 'Vui lòng chọn tỉnh/thành phố');
            validateField('DistrictName', 'Vui lòng chọn quận/huyện');
            validateField('WardName', 'Vui lòng chọn phường/xã');
            validateField('Description', 'Vui lòng không bỏ trống mô tả');
            validateField('Latitude', 'Thiếu thông tin tọa độ (latitude)');
            validateField('Longitude', 'Thiếu thông tin tọa độ (longitude)');

            if (!isValid) {
                e.preventDefault();
            }
        });

        // Auto hide error as user corrects
        $('#Name, #Phone, #Description').on('input', function () {
            const id = $(this).attr('id');
            if ($(this).val().trim()) {
                $(`[data-valmsg-for="${id}"]`).hide();
            }
        });

        $('#Status, #CityName, #DistrictName, #WardName').on('change', function () {
            const id = $(this).attr('id');
            if ($(this).val()) {
                $(`[data-valmsg-for="${id}"]`).hide();
            }
        });
    });
</script>