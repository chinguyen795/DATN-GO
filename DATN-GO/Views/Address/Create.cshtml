@model DATN_GO.Models.Addresses
@{
    ViewData["Title"] = "Thêm địa chỉ mới";
}

<!-- Mapbox CSS -->
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />

<div class="container py-4">
    <h3 class="text-center mb-4">@ViewData["Title"]</h3>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success text-center">@TempData["Success"]</div>
    }
    @if (ViewBag.ShowDefaultModal == true)
    {
        <script>
            window.addEventListener('DOMContentLoaded', function () {
                var confirmModal = new bootstrap.Modal(document.getElementById('defaultConfirmModal'));
                confirmModal.show();
            });
        </script>
    }

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <form asp-action="Create" method="post">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="UserId" class="form-label">Người dùng</label>
                                <select asp-for="UserId" class="form-control" asp-items="ViewBag.Users">
                                    <option value="">-- Chọn người dùng --</option>
                                </select>
                                <span asp-validation-for="UserId" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Status" class="form-label">Trạng thái</label>
                                <select asp-for="Status" class="form-control">
                                    <option value="Mặc định">Mặc định</option>
                                    <option value="Không mặc định">Không mặc định</option>
                                </select>
                                <span asp-validation-for="Status" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Tỉnh / Thành phố</label>
                                <select id="city" class="form-control">
                                    <option value="">-- Chọn tỉnh --</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Quận / Huyện</label>
                                <select id="district" class="form-control">
                                    <option value="">-- Chọn huyện --</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Phường / Xã</label>
                                <select id="ward" class="form-control">
                                    <option value="">-- Chọn xã --</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Discription" class="form-label">Địa chỉ</label>
                            <input asp-for="Discription" class="form-control" readonly />
                            <span asp-validation-for="Discription" class="text-danger"></span>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="Latitude" class="form-label">Vĩ độ</label>
                                <input asp-for="Latitude" class="form-control" />
                                <span asp-validation-for="Latitude" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Longitude" class="form-label">Kinh độ</label>
                                <input asp-for="Longitude" class="form-control" />
                                <span asp-validation-for="Longitude" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a asp-action="Address" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Quay về danh sách
                            </a>

                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Lưu địa chỉ
                            </button>
                        </div>
                    </form>

                </div>
            </div>

            <!-- Map container -->
            <div id="map" style="height: 400px;" class="mt-4 rounded border shadow-sm"></div>
        </div>
    </div>
</div>
@* Modal xác nhận  *@
<div class="modal fade" id="defaultConfirmModal" tabindex="-1" aria-labelledby="defaultConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="defaultConfirmModalLabel">Xác nhận địa chỉ mặc định</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                Người dùng đã có địa chỉ mặc định: <br />
                <strong>@ViewBag.ExistingDefault</strong> <br /><br />
                Bạn có muốn thay thế bằng địa chỉ mới không?
            </div>
            <div class="modal-footer">
                <form method="post" asp-action="ConfirmReplaceDefault">
                    <input type="hidden" name="confirm" value="true" />
                    <button type="submit" class="btn btn-danger">Có, thay thế</button>
                </form>

                <form method="post" asp-action="ConfirmReplaceDefault">
                    <input type="hidden" name="confirm" value="false" />
                    <button type="submit" class="btn btn-secondary">Không</button>
                </form>
            </div>

        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>

<script>
    const apiBase = "https://localhost:7096";
    mapboxgl.accessToken = 'pk.eyJ1IjoiaG9hbmdraGFuZzE2MDIiLCJhIjoiY21hYXViNTcyMDdwODJrc2N1bmVwY3h6eiJ9.MgDmLsya34LTrqNPE7WiLw';

    let map;
    let marker;

    function resetDropdown(selector, placeholder) {
        $(selector).html(`<option value="">${placeholder}</option>`);
    }

    function getCoordinatesFromAddress(address) {
        const encoded = encodeURIComponent(address);
        const url = `https://nominatim.openstreetmap.org/search?q=${encoded}&format=json`;

        fetch(url)
            .then(res => res.json())
            .then(data => {
                if (data.length > 0) {
                    const lat = data[0].lat;
                    const lon = data[0].lon;
                    $('#Latitude').val(lat);
                    $('#Longitude').val(lon);
                    updateMap(lat, lon);
                } else {
                    alert("Không tìm thấy tọa độ.");
                }
            });
    }

    function updateMap(lat, lon) {
        const lng = parseFloat(lon);
        const latitude = parseFloat(lat);

        if (!map) {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [lng, latitude],
                zoom: 15,
                pitch: 60,
                bearing: -45,
                antialias: true
            });
            map.addControl(new mapboxgl.NavigationControl());
        } else {
            map.flyTo({ center: [lng, latitude], essential: true });
        }

        if (marker) marker.remove();

        marker = new mapboxgl.Marker({ color: 'red' })
            .setLngLat([lng, latitude])
            .addTo(map);
    }

    // Load dropdown data
    fetch(`${apiBase}/api/cities`)
        .then(res => res.json())
        .then(data => {
            data.forEach(city => {
                $('#city').append(`<option value="${city.id}">${city.cityName}</option>`);
            });
        });

    $('#city').on('change', function () {
        const cityId = $(this).val();
        resetDropdown('#district', '-- Chọn huyện --');
        resetDropdown('#ward', '-- Chọn xã --');
        if (!cityId) return;

        fetch(`${apiBase}/api/districts/city/${cityId}`)
            .then(res => res.json())
            .then(data => {
                data.forEach(d => {
                    $('#district').append(`<option value="${d.id}">${d.districtName}</option>`);
                });
            });
    });

    $('#district').on('change', function () {
        const districtId = $(this).val();
        resetDropdown('#ward', '-- Chọn xã --');
        if (!districtId) return;

        fetch(`${apiBase}/api/wards/district/${districtId}`)
            .then(res => res.json())
            .then(data => {
                data.forEach(w => {
                    $('#ward').append(`<option value="${w.id}">${w.wardName}</option>`);
                });
            });
    });

    $('#ward').on('change', function () {
        const wardName = $('#ward option:selected').text();
        const districtName = $('#district option:selected').text();
        const cityName = $('#city option:selected').text();
        const fullAddress = `${wardName}, ${districtName}, ${cityName}`;

        $('#Discription').val(fullAddress);
        getCoordinatesFromAddress(fullAddress);
    });
</script>


