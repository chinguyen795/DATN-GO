﻿﻿@using DATN_GO.ViewModels
@{
    var images = ViewBag.Images as List<string> ?? new List<string>();
    var variants = ViewBag.VariantOptions as List<VariantWithValuesViewModel>;
    var variantCombinations = ViewBag.VariantCombinations as List<DATN_GO.ViewModels.VariantCombinationViewModel> ?? new
    List<DATN_GO.ViewModels.VariantCombinationViewModel>();
    var priceInfo = ViewBag.MinMaxPrice as DATN_GO.ViewModels.MinMaxPriceResponse;
}

<div class="row mb-5">
    <!-- Product Image Section -->
    <div class="col-md-6 mb-4">
        <!-- Main Carousel -->
        @if (images.Count > 0)
        {
            <!-- Carousel Main -->
            <div id="productCarousel" class="carousel slide mb-3" data-bs-ride="carousel">
                <div class="carousel-inner">
                    @for (int i = 0; i < images.Count; i++)
                    {
                        <div id="mainImage" class="carousel-item active">
                            <img id="mainProductImage" src="@images.FirstOrDefault()" class="d-block w-100 border rounded"
                                 alt="Hình ảnh sản phẩm">
                        </div>
                    }
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>

            <!-- Thumbnails with Navigation -->
            @if (variants != null && variants.Count > 0)
            {
                <div class="position-relative">
                    <button class="thumbnail-nav prev" type="button" id="scrollPrev">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="thumbnails-container">
                        <div class="thumbnails-wrapper">
                            @for (int i = 0; i < images.Count; i++)
                            {
                                var matchingVariant = variantCombinations.FirstOrDefault(v => v.Image == images[i]);

                                <img src="@images[i]"
                                     class="product-thumbnail @(i == 0 ? "active" : "")"
                                     data-bs-target="#productCarousel"
                                     data-bs-slide-to="@i"
                                     data-variant-value-ids="@(matchingVariant != null ? string.Join(",", matchingVariant.VariantValueIds) : "")" />
                            }
                        </div>
                    </div>
                    <button class="thumbnail-nav next" type="button" id="scrollNext">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            }

        }
        else
        {
            <p>Không có hình ảnh sản phẩm.</p>
        }
    </div>
    <!-- Product Information Section -->
    <div class="col-md-6">
        <!-- Store Information -->
        <div class="pb-2 mb-2 border-bottom">
            <div class="d-flex align-items-center">
                <img src="@ViewBag.StoreLogo" alt="Logo cửa hàng" class="rounded-circle me-2 logo-store"
                     style="width: 48px; height: 48px; object-fit: cover;">
                <div class="flex-grow-1">
                    <h5 class="mb-0">@ViewBag.StoreName</h5>
                    <div class="d-flex align-items-center mt-1">
                        <div class="text-muted me-3">
                            <!--<small>
                                    <i class="fas fa-star text-warning"></i>
                            @($"{ViewBag.Rating} ({ViewBag.Reviews} đánh giá)")
                                </small>-->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Product Information -->
        <h2 class="mb-3">@ViewBag.ProductName</h2>
        <div class="mb-3 d-flex align-items-center">
            <span class="text-danger fw-bold fs-3"
                  style="white-space: nowrap; font-family: Arial, sans-serif; font-size: 16px; font-weight: 600;">
                <span id="productPriceDisplay" class="text-crimson fw-bold fs-3">
                    @if (priceInfo != null)
                    {
                        if (priceInfo.IsVariant)
                        {
                            if (priceInfo.MinPrice == priceInfo.MaxPrice)
                            {
                                @($"{(priceInfo.MinPrice):N0} đ")
                            }
                            else
                            {
                                @($"{(priceInfo.MinPrice):N0} đ - {(priceInfo.MaxPrice):N0} đ")
                            }
                        }
                        else
                        {
                            @($"{(priceInfo.Price):N0} đ")
                        }
                    }
                    else
                    {
                        <span class="text-muted">Không có giá</span>
                    }
                </span>
            </span>
        </div>

        <!-- Rating -->
        <div class="mb-4">
            <div class="d-flex align-items-center">
                <div class="text-warning me-2">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star-half-alt"></i>
                </div>
                <span>4.5 (245 đánh giá)</span>
            </div>
        </div>

        <!-- Product Variants -->
        <!-- Product Variants -->
        <div class="mb-4">
            @if (variants != null)
            {
                @for (int i = 0; i < variants.Count; i++)
                {
                    var variant = variants[i];
                    <div class="mb-3">
                        <h5>@variant.VariantName</h5>
                        <div class="d-flex gap-2 flex-wrap">
                            @foreach (var value in variant.Values)
                            {
                                var inputId = $"variant_{variant.VariantName}_{value.Id}";
                                <input type="radio"
                                       class="btn-check"
                                       name="variant_@variant.VariantName"
                                       id="@inputId"
                                       value="@value.Id"
                                       autocomplete="off" />
                                <label class="btn btn-outline-danger" for="@inputId">
                                    @value.ValueName
                                </label>
                            }
                        </div>
                    </div>
                }
            }
        </div>


        <!-- Quantity Selector -->
        <div class="mb-4">
            <h5>Số lượng</h5>
            <div class="d-flex align-items-center gap-3">
                <div class="input-group quantity-input-group">
                    <button class="btn btn-outline-secondary" type="button" id="btnDecreaseProductQuantity">-</button>
                    <input class="form-control text-center" value="1" min="1" id="productQuantityInput" step="1" style="width: 100%; max-width: 120px;">
                    <button class="btn btn-outline-secondary" type="button" id="btnIncreaseProductQuantity">+</button>
                </div>
                <span class="text-muted" id="productQuantityDisplay">Còn lại: @Model.Quantity sản phẩm</span>
            </div>
        </div>


        <form id="addToCartForm" asp-controller="Cart" asp-action="AddToCart" method="post">
            @Html.AntiForgeryToken()

            <!-- Hidden product ID -->
            <input type="hidden" name="ProductId" value="@Model.Id" />
            <div id="variantInputsContainer"></div>
            <!-- Hidden Quantity -->
            <input type="hidden" name="Quantity" id="QuantityHidden" value="1" />

            <div class="d-grid gap-2 mt-3">
                <button type="submit" class="btn btn-outline-primary btn-lg">Thêm vào giỏ hàng</button>
            </div>
        </form>



    </div>
</div>

<div class="d-flex align-items-center container mb-3">
    <hr class="flex-grow-1 border-danger border-1 opacity-100">
</div>

<div class="mb-4">
    <h3>Thông tin chi tiết:</h3>

    <ul class="list-unstyled text-muted mb-3">
        <li><strong>Nơi xuất xứ:</strong> @Model.PlaceOfOrigin</li>
        <li><strong>Thương hiệu:</strong> @Model.Brand</li>
        <li><strong>Mô tả:</strong> @Model.Description</li>
    </ul>
</div>
<script>
    const variantCombinations = @Html.Raw(Json.Serialize(variantCombinations));
    console.log("Variant Combinations:", variantCombinations);

    let currentVariantPrice = parseFloat("@((priceInfo != null && !priceInfo.IsVariant && priceInfo.Price.HasValue) ? priceInfo.Price.Value.ToString("0.##") : "0")");

    // -------------------------
    // FIX: Tách trường hợp có biến thể / không có biến thể
    // -------------------------
    let totalQuantity = 0;
    if (@(priceInfo != null && priceInfo.IsVariant ? "true" : "false")) {
        // Có biến thể -> cộng tất cả quantity của variant combinations
        totalQuantity = variantCombinations.reduce((sum, v) => sum + v.quantity, 0);
    } else {
        // Không có biến thể -> lấy quantity trực tiếp từ Model
        totalQuantity = parseInt("@Model.Quantity") || 0;
    }

    let availableStock = totalQuantity;

    const quantityDisplay = document.getElementById("productQuantityDisplay");
    if (quantityDisplay) {
        quantityDisplay.textContent = `Còn lại: ${totalQuantity} sản phẩm`;
    }

    const selectedVariantsMap = new Map();

    function updateTotalPrice() {
        const quantity = parseInt(document.getElementById("productQuantityInput").value) || 1;
        const total = quantity * currentVariantPrice;
        document.getElementById("productPriceDisplay").textContent = total.toLocaleString("vi-VN") + " đ";
    }

    // Xử lý chọn biến thể
    document.querySelectorAll('.btn-check').forEach(input => {
        input.addEventListener('change', () => {
            selectedVariantsMap.set(input.name, parseInt(input.value));

            const selectedArray = Array.from(selectedVariantsMap.values()).sort((a, b) => a - b);

            // Kiểm tra và tìm variant combination phù hợp
            const match = variantCombinations.find(variant => {
                const sortedIds = [...variant.variantValueIds].sort((a, b) => a - b);
                return JSON.stringify(sortedIds) === JSON.stringify(selectedArray);
            });

            // Nếu tìm thấy match, cập nhật giá và số lượng
            if (match) {
                currentVariantPrice = match.price;
                updateTotalPrice();

                if (quantityDisplay) {
                    quantityDisplay.textContent = `Còn lại: ${match.quantity} sản phẩm`;
                }

                const mainImage = document.getElementById('mainProductImage');
                if (mainImage && match.image) {
                    mainImage.src = match.image;
                }
            } else {
                // Nếu không có kết hợp đầy đủ
                currentVariantPrice = 0;
                updateTotalPrice();

                if (quantityDisplay) {
                    quantityDisplay.textContent = `Còn lại: ${totalQuantity} sản phẩm`;
                }
            }

            updateFormHiddenInputs();
        });
    });

    const quantityInput = document.getElementById("productQuantityInput");
    const hiddenQuantity = document.getElementById("QuantityHidden");

    document.getElementById("btnIncreaseProductQuantity").addEventListener("click", () => {
        quantityInput.value = parseInt(quantityInput.value) + 1;
        hiddenQuantity.value = quantityInput.value;
        updateTotalPrice();
        updateFormHiddenInputs();
    });

    document.getElementById("btnDecreaseProductQuantity").addEventListener("click", () => {
        quantityInput.value = Math.max(1, parseInt(quantityInput.value) - 1);
        hiddenQuantity.value = quantityInput.value;
        updateTotalPrice();
        updateFormHiddenInputs();
    });

    quantityInput.addEventListener("input", () => {
        hiddenQuantity.value = quantityInput.value;
        updateTotalPrice();
        updateFormHiddenInputs();
    });

    function updateFormHiddenInputs() {
        const container = document.getElementById("variantInputsContainer");
        if (!container) return;

        container.innerHTML = "";

        const checkedRadios = document.querySelectorAll("input[type=radio]:checked");

        if (checkedRadios.length === 0) {
            const emptyInput = document.createElement("input");
            emptyInput.type = "hidden";
            emptyInput.name = "VariantValueIds";
            emptyInput.value = "";
            container.appendChild(emptyInput);
        } else {
            checkedRadios.forEach(radio => {
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = "VariantValueIds";
                input.value = radio.value;
                container.appendChild(input);
            });
        }

        hiddenQuantity.value = quantityInput.value || "1";
    }

    function setMainImage(src) {
        const mainImage = document.getElementById('mainProductImage');
        if (mainImage) {
            mainImage.src = src;
        }
    }

    function highlightThumbnailBySrc(src) {
        document.querySelectorAll('.product-thumbnail').forEach(img => {
            img.classList.toggle('active', img.src === src);
        });
    }

    document.querySelectorAll('.product-thumbnail').forEach(thumbnail => {
        thumbnail.addEventListener('click', () => {
            setMainImage(thumbnail.src);
            highlightThumbnailBySrc(thumbnail.src);

            const variantIdsStr = thumbnail.getAttribute('data-variant-value-ids');
            if (variantIdsStr) {
                const variantIds = variantIdsStr.split(',').map(id => parseInt(id.trim()));
                variantIds.forEach(id => {
                    const input = document.querySelector(`input[type=radio][value="${id}"]`);
                    if (input && !input.checked) {
                        input.checked = true;
                        input.dispatchEvent(new Event('change'));
                    }
                });
            }
        });
    });

    document.querySelectorAll('.btn-check').forEach(input => {
        input.addEventListener('change', () => {
            if (!input.checked) return;

            const selectedValues = Array.from(document.querySelectorAll('.btn-check:checked')).map(i => parseInt(i.value));

            const match = variantCombinations.find(v => {
                return v.variantValueIds.every(id => selectedValues.includes(id));
            });

            if (match && match.image) {
                setMainImage(match.image);
                highlightThumbnailBySrc(match.image);
            }
        });
    });

    updateFormHiddenInputs();
</script>

<script>
    document.getElementById("addToCartForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        // đảm bảo các input ẩn variant đã được cập nhật
        updateFormHiddenInputs();

        let errors = [];

        // -------------------------
        // FIX: Kiểm tra tồn kho theo 2 trường hợp
        // -------------------------
        let availableQuantity = 0;
        if (@(priceInfo != null && priceInfo.IsVariant ? "true" : "false")) {
            // Lấy số lượng tồn kho từ text hiển thị (biến thể)
            const quantityDisplayText = document.getElementById("productQuantityDisplay")?.textContent || "";
            const availableMatch = quantityDisplayText.match(/Còn lại:\s*(\d+)/);
            availableQuantity = availableMatch ? parseInt(availableMatch[1]) : 0;
        } else {
            // Không có biến thể → lấy từ Model
            availableQuantity = parseInt("@Model.Quantity") || 0;
        }

        // Lấy số lượng người dùng nhập
        const quantityInputEl = document.getElementById("productQuantityInput");
        const requestedQuantity = parseInt(quantityInputEl?.value) || 1;

        // Kiểm tra vượt tồn kho
        if (requestedQuantity > availableQuantity) {
            errors.push(`Số lượng bạn chọn (${requestedQuantity}) vượt quá số lượng tồn (${availableQuantity}).`);
        }

        // Kiểm tra biến thể bắt buộc (nếu có)
        const variantGroups = document.querySelectorAll('[name^="variant_"]');
        if (variantGroups.length > 0) {
            const uniqueGroups = [...new Set(Array.from(variantGroups).map(v => v.name))];
            uniqueGroups.forEach(groupName => {
                const checked = document.querySelector(`input[name="${groupName}"]:checked`);
                if (!checked) {
                    errors.push(`Vui lòng chọn ${groupName.replace("variant_", "")}.`);
                }
            });
        }

        if (errors.length > 0) {
            showToast(errors.join("\n"), false);
            return;
        }

        const form = this;
        const formData = new FormData(form);

        try {
            const response = await fetch(form.action, {
                method: (form.method || "POST").toUpperCase(),
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                credentials: 'same-origin'
            });

            const contentType = response.headers.get('content-type') || '';

            if (contentType.includes('application/json')) {
                const data = await response.json();

                if (response.ok && (data.success === undefined || data.success === true)) {
                    showToast(data.message || 'Đã thêm vào giỏ hàng.', true);
                    return;
                }

                const errMsg = data.message || '';
                const errCode = data.errorCode || '';

                if (errCode === 'EXCEEDED_STOCK' || /vượt|tồn|exceed/i.test(errMsg)) {
                    showToast('Bạn đã thêm vượt quá số lượng hiện có của sản phẩm.', false);
                } else {
                    showToast(errMsg || 'Lỗi thêm vào giỏ hàng.', false);
                }
                return;
            } else {
                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }
                const text = await response.text();
                if (/vượt|tồn|exceed/i.test(text)) {
                    showToast('Bạn đã thêm vượt quá số lượng hiện có của sản phẩm.', false);
                } else {
                    showToast('Hoàn tất. Vui lòng kiểm tra giỏ hàng.', true);
                    window.location.reload();
                }
                return;
            }
        } catch (err) {
            console.error(err);
            showToast('Lỗi kết nối. Vui lòng thử lại.', false);
        }
    });
</script>