@{
    var useContainer = ViewData["UseContainer"] as bool? ?? true;
}
<!doctype html>
<html lang="en">

<head>
    <title>Title</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/9.0.0/mdb.min.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital@0;1&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />


    <link rel="stylesheet" href="" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <!-- Google Fonts
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <!-- MDB -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/9.0.0/mdb.min.css" rel="stylesheet" />
    <!-- AOS CSS -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <!-- Owl Carousel CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css">
    <!-- Bootstrap Select CSS -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">

    <link rel="stylesheet" href="~/css/homestyle.css" />
    <style>
        /* Nút tròn mở chat */
        #aiChatFab {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 1065;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(0,0,0,.2);
        }

        /* Hộp chat */
        #aiChatBox {
            position: fixed;
            right: 20px;
            bottom: 86px;
            z-index: 1065;
            width: 360px;
            max-height: 70vh;
            display: none;
            box-shadow: 0 12px 28px rgba(0,0,0,.18);
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
            border: 1px solid rgba(0,0,0,.08);
        }

        #aiChatHeader {
            background: #dc143c;
            color: #fff;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #aiChatMessages {
            padding: 12px;
            height: 360px;
            overflow-y: auto;
            background: #fafafa;
        }

        .ai-bubble {
            margin: 8px 0;
            padding: 10px 12px;
            border-radius: 10px;
            max-width: 85%;
            white-space: pre-wrap;
        }

            .ai-bubble.user {
                background: #e9f2ff;
                align-self: flex-end;
                margin-left: auto;
            }

            .ai-bubble.bot {
                background: #fff;
                border: 1px solid #eee;
            }

        #aiChatInputBar {
            display: flex;
            gap: 8px;
            padding: 10px;
            border-top: 1px solid #eee;
            background: #fff;
        }

        #aiMsg {
            flex: 1;
        }

        #aiChatMessages a {
            text-decoration: none;
        }

            #aiChatMessages a:hover {
                text-decoration: underline;
            }
    </style>

</head>

<body>
    <header class="bg-crimson mb-3">
        <nav class="container navbar navbar-expand-lg navbar-light bg-crimson shadow-none py-2">
            <div class="container-fluid px-0">
                <div class="row w-100 align-items-center flex-nowrap gx-2">
                    <!-- Logo -->
                    <div class="col-auto d-flex align-items-center">
                        <a class="navbar-brand d-flex align-items-center p-0" href="#">
                            <img src="~/images/logo.png" alt="Logo" height="50" style="object-fit:contain;">
                        </a>
                    </div>
                    <!-- Search (desktop only) -->
                    <div class="col flex-grow-1 d-none d-lg-block">
                        <form class="d-flex" style="max-width: 400px; margin: 0 auto;">
                            <input class="form-control form-control-sm rounded-pill w-100" type="search"
                                   placeholder="Tìm kiếm" aria-label="Search">
                        </form>
                    </div>
                    <!-- Menu, Cart, Account (desktop only) -->
                    <div class="col-auto d-none d-lg-flex align-items-center gap-3">
                        <!-- Menu (navbar links) -->
                        <div>
                            <div class="collapse navbar-collapse" id="mainNavbar">
                                <ul class="navbar-nav mb-2 mb-lg-0 fw-bold flex-row gap-3 align-items-center">
                                    <li class="nav-item">
                                        <a class="nav-link active text-crimson d-flex align-items-center gap-1"
                                           aria-current="page" asp-controller="Home" asp-action="Index">
                                            Trang chủ
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link text-crimson d-flex align-items-center gap-1"
                                           asp-controller="Store" asp-action="Store">
                                            Cửa hàng
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link text-crimson d-flex align-items-center gap-1"
                                           asp-controller="Products" asp-action="Products">
                                            Sản phẩm
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link text-crimson d-flex align-items-center gap-1"
                                           asp-controller="Blog" asp-action="Blog">
                                            Bài viết
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <!-- Cart -->
                        <a asp-action="index" asp-controller="cart" class="nav-link position-relative align-items-center p-0">
                            <i class="bi bi-cart-fill text-white icon-md header-icon"></i>
                            @* <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-white text-crimson"
                            style="font-size:0.7rem;">99</span> *@
                        </a>
                        <!-- Account -->
                        @{
                            var fullName = Context.Session.GetString("FullName");
                        }
                        <div class="dropdown d-none d-lg-flex align-items-center gap-1 mx-2">
                            <button class="account btn btn-crimson dropdown-toggle text-white border-bottom d-flex align-items-center gap-1 py-1 px-2"
                                    type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-person-circle icon-md header-icon"></i> Tài khoản
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                                @if (string.IsNullOrEmpty(fullName))
                                {
                                    <!-- Chưa đăng nhập -->
                                    <li>
                                        <a class="dropdown-item d-flex align-items-center gap-2" asp-action="Login" asp-controller="UserAuthentication">
                                            <i class="bi bi-person-circle icon-sm"></i> Đăng
                                            nhập
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item d-flex align-items-center gap-2" asp-action="Register" asp-controller="UserAuthentication">
                                            <i class="bi bi-person-plus-fill icon-sm"></i> Đăng
                                            ký
                                        </a>
                                    </li>
                                }
                                else
                                {
                                    <!-- Đã đăng nhập -->
                                    <li>
                                        <span class="dropdown-item text-muted d-flex align-items-center gap-2">
                                            <i class="bi bi-person-check icon-sm"></i> Xin chào, @fullName
                                        </span>
                                    </li>
                                    <li>
                                        <a class="dropdown-item d-flex align-items-center gap-2" asp-controller="Profile"
                                           asp-action="Index">
                                            <i class="bi bi-person-square icon-sm"></i> Thông tin cá
                                            nhân
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item d-flex align-items-center gap-2"
                                           asp-controller="UserAuthentication" asp-action="Logout">
                                            <i class="bi bi-box-arrow-right icon-sm"></i> Đăng xuất
                                        </a>
                                    </li>
                                }
                            </ul>
                        </div>
                    </div>
                    <!-- Nút menu hamburger chỉ hiện ở mobile, luôn nằm bên phải -->
                    <div class="col-auto d-block d-lg-none ms-auto">
                        <button class="navbar-toggler text-white p-2" type="button" data-bs-toggle="offcanvas"
                                data-bs-target="#offcanvasExample" aria-controls="offcanvasExample"
                                aria-label="Toggle navigation">
                            <i class="bi bi-list icon-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Offcanvas Menu -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel">
        <div class="offcanvas-header bg-crimson text-white">
            <h5 class="offcanvas-title" id="offcanvasExampleLabel">Menu</h5>
            <button type="button" class="btn-close text-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="d-flex flex-column">
                <!-- Search form and cart -->
                <div class="mb-3">
                    <div class="d-flex align-items-center">
                        <form class="d-flex flex-grow-1">
                            <input class="form-control me-2 rounded-pill" type="search" placeholder="Tìm kiếm"
                                   aria-label="Search">
                        </form>
                        <a href="./Cart.html" class="nav-link text-crimson position-relative ms-2">
                            <i class="fas fa-cart-shopping icon-md"></i>
                            <span class="badge rounded-pill badge-notification bg-crimson position-absolute top-0 start-100 translate-middle text-white">99</span>
                        </a>
                    </div>
                </div>

                <!-- Navigation links -->
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active text-crimson" href="./Home.html">
                            Trang chủ
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-crimson" href="./Diner.html">
                            Cửa hàng
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-crimson" href="./Products.html">
                            Sản phẩm
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-crimson" href="./Blog.html">
                            Bài viết
                        </a>
                    </li>

                </ul>

                <!-- User actions -->
                <div class="mt-3">
                    <button class="btn btn-crimson w-100 mb-2" data-bs-toggle="modal" href="#exampleModalToggle">
                        Đăng nhập
                    </button>
                    <button class="btn btn-outline-crimson w-100" data-bs-toggle="modal" href="#exampleModalToggle2">
                        Đăng ký
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (useContainer)
    {
        <div class="container">
            @RenderBody()
        </div>
    }
    else
    {
        @RenderBody()
    }



    <footer class="bg-crimson text-white py-4">
        <div class="container">
            <div class="row">
                <div class="col-lg-3 col-md-6 col-sm-6">
                    <h6 class="text-uppercase mb-3">Về Chúng Tôi</h6>
                    <ul class="list-unstyled">
                        <li class="mb-3"><a href="#" class="text-white text-decoration-none">Giới thiệu</a></li>
                        <li class="mb-3"><a href="#" class="text-white text-decoration-none">Quy chế</a></li>
                        <li class="mb-3"><a href="#" class="text-white text-decoration-none">Bảo mật thông tin</a></li>
                        <li class="mb-3"><a href="#" class="text-white text-decoration-none">Giấy phép</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6">
                    <h6 class="text-uppercase mb-3">Dịch Vụ Khách Hàng</h6>
                    <ul class="list-unstyled">
                        <li class="mb-3"><a href="#" class="text-white text-decoration-none">Trợ giúp</a></li>
                        <li class="mb-3">
                            <a href="#" class="text-white text-decoration-none">Giải quyết khiếu nại</a>
                        </li>
                        <li class="mb-3"><a href="#" class="text-white text-decoration-none">Liên hệ</a></li>
                        <li class="mb-3"><a href="#" class="text-white text-decoration-none">CSKH</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6">
                    <h6 class="text-uppercase mb-3">Công Việc</h6>
                    <ul class="list-unstyled">
                        <li class="mb-3"><a href="#" class="text-white text-decoration-none">Hợp tác bán hàng</a></li>
                        <li class="mb-3"><a href="#" class="text-white text-decoration-none">Hợp tác vận chuyển</a></li>
                        <li class="mb-3"><a href="#" class="text-white text-decoration-none">Liên hệ công việc</a></li>
                        <li class="mb-3"><a href="#" class="text-white text-decoration-none">Quảng cáo</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 text-center">
                    <img src="~/images/logo.png" alt="Logo GO" class="img-fluid mb-3" height="70">
                    <div>
                        <a href="#" class="text-white me-3"><i class="fab fa-facebook-f footer-social-icon"></i></a>
                        <a href="#" class="text-white me-3"><i class="fab fa-instagram footer-social-icon"></i></a>
                        <a href="#" class="text-white me-3"><i class="fab fa-youtube footer-social-icon"></i></a>
                        <a href="#" class="text-white"><i class="fab fa-tiktok footer-social-icon"></i></a>
                    </div>
                </div>
            </div>
            <hr class="my-4">
            <div class="">
                <p class="small">
                    Toà nhà FPT Polytechnic, đường số 22, phường Thường Thạnh, quận Cái Răng, TP. Cần Thơ
                </p>

                <ul class="list-inline small">
                    <li class="list-inline-item">
                        <a href="#" class="text-white text-decoration-none">Privacy Policy</a>
                    </li>
                    <li class="list-inline-item">
                        <a href="#" class="text-white text-decoration-none">Terms of Use</a>
                    </li>
                    <li class="list-inline-item">
                        <a href="#" class="text-white text-decoration-none">Accessibility</a>
                    </li>
                    <li class="list-inline-item"><a href="#" class="text-white text-decoration-none">Sitemap</a></li>
                </ul>
                <p class="small">GO: mamnon02@gmail.com</p>
            </div>
        </div>
    </footer>





    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="~/lib/popper.js/umd/popper.min.js"></script>
    <script src="~/js/Address.js"></script>
    <script src="~/js/Carousel.js"></script>
    <script src="~/js/Cart.js"></script>
    <script src="~/js/ConfirmationCode.js"></script>
    <script src="~/js/DetailProduct.js"></script>
    <script src="~/js/NotificationToast.js"></script>
    <script src="~/js/Orders.js"></script>
    <script src="~/js/Profile.js"></script>
    <script src="~/js/SalesRegistration.js"></script>
    <script src="~/js/Vouchers.js"></script>



    <script src="~/js/Toast.js"></script>

    <script src="~/js/checkboxcart.js"></script>


    <!-- Bootstrap JavaScript Libraries -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
      integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
      crossorigin="anonymous">
    </script> -->

    <script src="./Scripts/Carousel.js"></script>

    <!-- AOS JS -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Owl Carousel JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
    <script>
        function previewImage(input, imgId, promptId) {
            const file = input.files[0];
            const img = document.getElementById(imgId);
            const prompt = document.getElementById(promptId);
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    img.src = e.target.result;
                    img.classList.remove('d-none');
                    if (prompt) prompt.classList.add('d-none');
                };
                reader.readAsDataURL(file);
            } else {
                img.src = '';
                img.classList.add('d-none');
                if (prompt) prompt.classList.remove('d-none');
            }
        }
    </script>
    <script>
        AOS.init({
            duration: 800,
            offset: 100,
            once: true
        });
    </script>
    <script>
        $(document).ready(function () {
            $('.category-carousel').owlCarousel({
                loop: true,
                margin: 10,
                nav: true,
                dots: false,
                navText: [
                    '<i class="bi bi-chevron-left"></i>',
                    '<i class="bi bi-chevron-right"></i>'
                ],
                responsive: {
                    0: {
                        items: 3,
                        margin: 5
                    },
                    400: {
                        items: 4,
                        margin: 10
                    },
                    576: {
                        items: 5
                    },
                    768: {
                        items: 6
                    },
                    992: {
                        items: 7
                    },
                    1200: {
                        items: 8
                    }
                },
                onInitialized: function () {
                    setTimeout(function () {
                        $('.scroll-indicator').fadeOut();
                    }, 3000);
                }
            });
        });
    </script>



    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1056">
        @if (TempData["ToastMessage"] != null && TempData["ToastType"] != null)
        {
            var toastType = TempData["ToastType"].ToString();
            var isSuccess = toastType == "success";
            <div class="toast @(isSuccess ? "" : "mt-3")" role="alert" aria-live="assertive" aria-atomic="true"
                 id="autoToast">
                <div class="toast-header @(isSuccess ? "bg-success" : "bg-danger") text-white">
                    <img src="@(isSuccess ? "/icons/happy.gif" : "/icons/sad.gif")" class="rounded me-2"
                         alt="@(isSuccess ? "Success" : "Error")" width="20" height="20">
                    <strong class="me-auto">@((isSuccess) ? "Thành công" : "Lỗi")</strong>
                    <small>Vừa xong</small>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"
                            aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    @TempData["ToastMessage"]
                </div>
            </div>
        }
    </div>
    @await RenderSectionAsync("Scripts", required: false)
    <!-- Floating Chat AI -->
    <button id="aiChatFab" class="btn btn-crimson">
        <i class="bi bi-chat-dots-fill text-white"></i>
    </button>

    <div id="aiChatBox" class="shadow">
        <div id="aiChatHeader">
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-robot"></i>
                <strong>Trợ Lý Gờ Ô</strong>
            </div>
            <button id="aiChatClose" class="btn btn-sm btn-light">Đóng</button>
        </div>

        <div id="aiChatMessages"></div>

        <div id="aiChatInputBar">
            <input id="aiMsg" class="form-control" placeholder="Hỏi về TMĐT: sản phẩm, đơn, doanh thu...">
            <button id="aiSend" class="btn btn-crimson">GỬI</button>

        </div>
    </div>
    <!-- /Floating Chat AI -->
    // THAY THẾ đoạn script chatbox cũ bằng code này:

    <script>
        (function () {
            const API_URL = 'https://localhost:7096/api/ai/chat';

            const fab = document.getElementById('aiChatFab');
            const box = document.getElementById('aiChatBox');
            const close = document.getElementById('aiChatClose');
            const msgs = document.getElementById('aiChatMessages');
            const input = document.getElementById('aiMsg');
            const send = document.getElementById('aiSend');

            function toggle() {
                box.style.display = (box.style.display === 'none' || !box.style.display) ? 'block' : 'none';
            }

            function addBubble(text, who) {
                const div = document.createElement('div');
                div.className = 'ai-bubble ' + (who === 'user' ? 'user' : 'bot');

                if (who === 'user') {
                    div.textContent = text; // User message dùng textContent
                } else {
                    // Bot message: convert text thành HTML có thể click
                    div.innerHTML = formatBotMessage(text);
                }

                msgs.appendChild(div);
                msgs.scrollTop = msgs.scrollHeight;
            }

            // Function chuyển đổi text thành HTML clickable
            function formatBotMessage(text) {
                if (!text) return '';

                // Bước 1: Escape HTML nguy hiểm
                let html = text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');

                // Bước 2: Chuyển URLs thành links
                html = html.replace(
                    /(https?:\/\/[^\s<>"{}|\\^`\[\]]+)/g,
                    '<a href="$1" class="text-crimson fw-semibold text-decoration-underline" target="_blank" rel="noopener">🔗 XEM NGAY</a>'
                );

                // Bước 3: Chuyển **text** thành <strong>
                html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

                // Bước 4: Chuyển \n thành <br>
                html = html.replace(/\n/g, '<br>');

                // Bước 5: Thêm style cho icons
                html = html.replace(/🛍️/g, '<span style="color: #dc143c;">🛍️</span>');
                html = html.replace(/💰/g, '<span style="color: #ffa500;">💰</span>');
                html = html.replace(/📦/g, '<span style="color: #4169e1;">📦</span>');
                html = html.replace(/🔗/g, '<span style="color: #dc143c;">🔗</span>');

                return html;
            }

            async function ask() {
                const text = input.value.trim();
                if (!text) return;

                // Hiển thị câu hỏi của user
                addBubble(text, 'user');
                input.value = '';

                // Chặn spam trong lúc chờ
                send.disabled = true;
                input.disabled = true;

                // Bubble chờ
                const wait = document.createElement('div');
                wait.className = 'ai-bubble bot';
                wait.innerHTML = '<i class="bi bi-three-dots" style="animation: blink 1s infinite;"></i> Đang suy nghĩ...';
                msgs.appendChild(wait);
                msgs.scrollTop = msgs.scrollHeight;

                try {
                    const res = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: text })
                    });

                    // Cố đọc JSON; nếu lỗi thì data = {}
                    let data = {};
                    try {
                        data = await res.json();
                    } catch (e) {
                        console.log('JSON parse error:', e);
                    }

                    // QUAN TRỌNG: Sử dụng innerHTML với formatBotMessage
                    const botReply = (data && data.answer) ? data.answer : '[AI không phản hồi]';
                    wait.innerHTML = formatBotMessage(botReply);
                    msgs.scrollTop = msgs.scrollHeight;

                } catch (e) {
                    wait.innerHTML = '<span style="color: red;">[Lỗi kết nối AI] ' + e.message + '</span>';
                    console.error('API error:', e);
                } finally {
                    send.disabled = false;
                    input.disabled = false;
                    input.focus();
                }
            }

            fab.addEventListener('click', toggle);
            close.addEventListener('click', toggle);
            send.addEventListener('click', ask);
            input.addEventListener('keydown', e => { if (e.key === 'Enter') ask(); });

            // Auto focus khi mở chatbox
            fab.addEventListener('click', () => {
                setTimeout(() => input.focus(), 300);
            });
        })();
    </script>

    <style>
        /* Thêm CSS cho chat links */
        #aiChatMessages a {
            color: #dc143c !important;
            text-decoration: underline !important;
            font-weight: 600 !important;
            transition: all 0.2s ease;
        }

            #aiChatMessages a:hover {
                color: #a01030 !important;
                text-decoration: none !important;
                background-color: rgba(220, 20, 60, 0.1);
                padding: 2px 4px;
                border-radius: 4px;
            }

        /* Animation cho loading */

        }
    </style>

</body>


</html>

<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
    window.onload = function () {
        google.accounts.id.initialize({
            client_id: "185130462575-kq61q46pbt3dggk8f6sgaes2hc321lgq.apps.googleusercontent.com",
            callback: handleGoogleLogin,
            auto_select: false, // không tự đăng nhập
            ux_mode: "popup"    // bật popup chọn tài khoản
        });

        // Kiểm tra element tồn tại trước khi thêm event listener
        const googleLoginBtn = document.getElementById("googleLoginBtn");
        if (googleLoginBtn) {
            googleLoginBtn.addEventListener("click", function () {
                google.accounts.id.prompt(); // gọi popup chọn tài khoản
            });
        }
    };

    function handleGoogleLogin(response) {
        const id_token = response.credential;

        fetch('/UserAuthentication/LoginWithGoogle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ idToken: id_token })
        })
            .then(async res => {
                if (res.ok) {
                    const data = await res.json();
                    localStorage.setItem("toastMessage", `Chào mừng ${data.fullName}, bạn đã đăng nhập bằng Google thành công!`);
                    localStorage.setItem("toastType", "success");
                    window.location.href = '/';
                } else {
                    alert("Đăng nhập bằng Google thất bại!");
                }
            })
            .catch(err => {
                console.error("Google login error:", err);
            });
    }

    function showToast(message, isSuccess = true) {
        const iconUrl = isSuccess ? "/icons/happy.gif" : "/icons/sad.gif";
        const title = isSuccess ? "Thành công" : "Lỗi";

        const toastHtml = `
                        <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true" id="dynamicToast"
                             style="position: fixed; top: 1rem; right: 1rem; z-index: 1060; min-width: 320px;">
                            <div class="toast-header d-flex align-items-center ${isSuccess ? "bg-success" : "bg-danger"} text-white">
                                <img src="${iconUrl}" alt="icon" width="20" height="20" class="me-2" />
                                <strong class="me-auto">${title}</strong>
                                <small class="text-white">Vừa xong</small>
                                <button type="button" class="btn-close btn-close-white ms-2" onclick="this.closest('.toast').remove()" aria-label="Close"></button>
                            </div>
                            <div class="toast-body">${message}</div>
                        </div>
                    `;
        document.body.insertAdjacentHTML('beforeend', toastHtml);
        setTimeout(() => document.getElementById('dynamicToast')?.remove(), 3000);
    }
    function mdToHtml(s) {
        if (!s) return '';
        return s
            .replace(/\[([^\]]+)\]\(([^)]+)\)/g,
                '<a href="$2" class="text-crimson fw-semibold" target="_self" rel="noopener">$1</a>')
            .replace(/\n/g, '<br>');
    }
    window.addEventListener('DOMContentLoaded', function () {
        const message = localStorage.getItem("toastMessage");
        const type = localStorage.getItem("toastType");

        if (message && type) {
            showToast(message, type === "success");
            localStorage.removeItem("toastMessage");
            localStorage.removeItem("toastType");
        }
    });
</script>