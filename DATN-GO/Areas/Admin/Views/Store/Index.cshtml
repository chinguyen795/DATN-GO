@model List<DATN_GO.ViewModels.AdminStorelViewModels>

<div class="page-wrapper">
    <header class="main-header" id="header">
        <nav class="navbar navbar-expand-lg navbar-light" id="navbar">
            <!-- Sidebar toggle button -->
            <button id="sidebar-toggler" class="sidebar-toggle">
                <span class="sr-only">Toggle navigation</span>
            </button>

            <span class="page-title" id="pageTitle">Quản lý cửa hàng</span>

            <div class="navbar-right">
                <ul class="nav navbar-nav">
                    <li class="custom-dropdown">
                        <a class="notify-toggler custom-dropdown-toggler" asp-controller="Notification" asp-action="Index">
                            <i class="mdi mdi-bell-outline icon"></i>
                        </a>
                    </li>
                    <li class="dropdown user-menu">
                        <button class="dropdown-toggle nav-link" data-toggle="dropdown">
                            <img src="@(!string.IsNullOrEmpty(ViewBag.UserInfo?.Avatar) ? ViewBag.UserInfo.Avatar : "/images/avt-user.jpg")"
                                 width="32" height="32" style="object-fit: cover;" loading="lazy" />
                            <span class="d-none d-lg-inline-block">@ViewBag.UserInfo?.FullName</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-right">
                            <li>
                                <a class="dropdown-link-item" asp-controller="Profile" asp-action="Index" asp-area="">
                                    <i class="mdi mdi-account-outline"></i>
                                    <span class="nav-text">Hồ Sơ</span>
                                </a>
                            </li>
                            <li class="dropdown-footer">
                                <a class="dropdown-link-item" href="/Admin/Decorates/Logout">
                                    <i class="mdi mdi-logout"></i> Đăng Xuất
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- CONTENT WRAPPER -->
    <div class="content-wrapper">
        <div class="content">
            <!-- Store List View -->
            <div id="storeListView" class="row">
                <div class="col-12">
                    <div class="card card-default">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h2 class="text-danger mb-0">Quản lý cửa hàng</h2>
                            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                                <button id="backBtn" class="btn btn-outline-primary me-3" style="display: none;">
                                    <i class="mdi mdi-arrow-left"></i> Quay lại
                                </button>
                            </div>
                        </div>

                        <div class="card-body">
                            <table id="productsTable" class="table table-hover table-product" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>STT</th>
                                        <th></th>
                                        <th>Tên cửa hàng</th>
                                        <th>Chủ sở hữu</th>
                                        <th>Ngày đăng ký</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>

                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model != null && Model.Any())
                                    {
                                        int index = 1;
                                        foreach (var store in Model)
                                        {
                                            <tr class="store-row" style="cursor: pointer;"
                                                data-store-id="@store.Id"
                                                data-name="@store.Name"
                                                data-owner="@store.OwnerName"
                                                data-date="@store.CreateAt.ToString("dd/MM/yyyy")"
                                                data-status="@store.Status"
                                                data-image="@store.Avatar">
                                                <td>@index</td>
                                                <td>
                                                    @if (!string.IsNullOrEmpty(store.Avatar))
                                                    {
                                                        <img src="@store.Avatar" class="clickable-image" data-src="@store.Avatar"
                                                             alt="Ảnh cửa hàng" width="60" style="cursor: pointer;" />
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">Không có ảnh</span>
                                                    }
                                                </td>
                                                <td>@store.Name</td>
                                                <td>@store.OwnerName</td>
                                                <td>@store.CreateAt.ToString("dd/MM/yyyy")</td>
                                                <td>
                                                    @if (store.Status == "Active")
                                                    {
                                                        <span class="badge badge-success">Đang hoạt động</span>
                                                    }
                                                    else if (store.Status == "Pending")
                                                    {
                                                        <span class="badge badge-warning">Chờ duyệt</span>
                                                    }
                                                    else if (store.Status == "Rejected")
                                                    {
                                                        <span class="badge badge-danger">Đã từ chối</span>
                                                    }

                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-primary" onclick="showStoreDetail('@store.Id', '@store.Name', '@store.OwnerName', '@store.CreateAt.ToString("dd/MM/yyyy")', '@store.Status.ToString()', '@store.Avatar')">
                                                        <i class="mdi mdi-eye"></i> Xem chi tiết
                                                    </button>
                                                </td>
                                            </tr>
                                            index++;
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">Không có cửa hàng nào.</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Store Detail View -->
            <div id="storeDetailView" style="display: none;">
                <!-- Store Info Card -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card card-default shadow-sm border-0">
                            <div class="card-body p-4">
                                <div class="row align-items-center">
                                    <div class="col-md-2 text-center mb-3 mb-md-0">
                                        <div class="store-avatar-wrapper position-relative">
                                            <img id="storeDetailImage" src="" alt="Ảnh cửa hàng"
                                                 class="rounded-circle border border-3 border-light shadow-sm clickable-image"
                                                 style="width: 120px; height: 120px; object-fit: cover; cursor: pointer;"
                                                 data-src="">
                                            <div class="position-absolute bottom-0 end-0">
                                                <span id="storeDetailStatus" class="badge fs-6 shadow-sm"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="store-info">
                                            <h3 id="storeDetailName" class="text-primary mb-3 fw-bold"></h3>
                                            <div class="info-item d-flex align-items-center mb-2">
                                                <i class="mdi mdi-account-circle text-muted me-2" style="font-size: 1.2rem;"></i>
                                                <div>
                                                    <span id="storeDetailOwner" class="fw-medium"></span>
                                                </div>
                                            </div>
                                            <div class="info-item d-flex align-items-center mb-2">
                                                <i class="mdi mdi-calendar text-muted me-2" style="font-size: 1.2rem;"></i>
                                                <div>
                                                    <span id="storeDetailDate" class="fw-medium"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-md-end">
                                        <div class="store-stats">
                                            <div class="row text-center">
                                                <div class="col-4">
                                                    <div class="stat-item p-3 bg-light rounded">
                                                        <h5 class="mb-0 text-primary fw-bold" id="productCount">0</h5>
                                                        <small class="text-muted">Sản phẩm</small>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <div class="stat-item p-3 bg-light rounded">
                                                        <h5 class="mb-0 text-success fw-bold" id="orderCount">0</h5>
                                                        <small class="text-muted">Đơn hàng</small>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <div class="stat-item p-3 bg-light rounded">
                                                        <h5 class="mb-0 text-info fw-bold" id="revenueCount">0</h5>
                                                        <small class="text-muted">Doanh thu</small>
                                                    </div>
                                                </div>
                                            </div>
                                            @* <div class="mt-3">
                                                <button class="btn btn-outline-primary btn-sm me-2">
                                                    <i class="mdi mdi-pencil"></i> Chỉnh sửa
                                                </button>
                                                <button class="btn btn-outline-secondary btn-sm">
                                                    <i class="mdi mdi-cog"></i> Cài đặt
                                                </button>
                                            </div> *@
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Tabs -->
                <div class="row">
                    <div class="col-12">
                        <ul class="nav nav-tabs" id="storeDetailTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab">
                                    <i class="mdi mdi-package-variant"></i> Sản phẩm
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">
                                    <i class="mdi mdi-cart"></i> Đơn hàng
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="payment-tab" data-bs-toggle="tab" data-bs-target="#payment" type="button" role="tab">
                                    <i class="mdi mdi-credit-card"></i> Thông tin chuyển khoản
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="storeDetailTabContent">
                            <!-- Products Tab -->
                            <div class="tab-pane fade show active" id="products" role="tabpanel">
                                <div class="card card-default">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Danh sách sản phẩm</h5>

                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Ảnh</th>
                                                        <th>Tên sản phẩm</th>
                                                        <th>Giá</th>
                                                        <th>Tồn kho</th>
                                                        <th>Danh mục</th>
                                                        <th>Trạng thái</th>
                                                        <th>Thao tác</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="productsTableBody">
                                                    <tr>
                                                        <td colspan="8" class="text-center text-muted py-4">
                                                            <i class="mdi mdi-package-variant-closed" style="font-size: 2rem;"></i>
                                                            <p class="mt-2">Chưa có sản phẩm nào</p>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Orders Tab -->
                            <div class="tab-pane fade" id="orders" role="tabpanel">
                                <div class="card card-default">
                                    <div class="card-header">
                                        <h5 class="mb-0">Danh sách đơn hàng</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Mã đơn hàng</th>
                                                        <th>Khách hàng</th>
                                                        <th>Ngày đặt</th>
                                                        <th>Tổng tiền</th>
                                                        <th>Trạng thái</th>
                                                        <th>Thao tác</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="ordersTableBody">
                                                    <tr>
                                                        <td colspan="6" class="text-center text-muted py-4">
                                                            <i class="mdi mdi-cart-outline" style="font-size: 2rem;"></i>
                                                            <p class="mt-2">Chưa có đơn hàng nào</p>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Info Tab -->
                            <div class="tab-pane fade" id="payment" role="tabpanel">
                                <div class="card card-default">
                                    <div class="card-header">
                                        <h5 class="mb-0">Thông tin chuyển khoản</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label text-dark font-weight-medium"><strong>Tên ngân hàng:</strong></label>
                                                    <p id="bankName" class="form-control-plaintext text-muted">Chưa cập nhật</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label text-dark font-weight-medium"><strong>Số tài khoản:</strong></label>
                                                    <p id="accountNumber" class="form-control-plaintext text-muted">Chưa cập nhật</p>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label text-dark font-weight-medium"><strong>Tên chủ tài khoản:</strong></label>
                                                    <p id="accountHolder" class="form-control-plaintext text-muted">Chưa cập nhật</p>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label text-dark font-weight-medium"><strong>Chi nhánh:</strong></label>
                                                    <p id="bankBranch" class="form-control-plaintext text-muted">Chưa cập nhật</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal ảnh phóng to -->
            <div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content text-center p-4 rounded shadow" style="background-color: #fff;">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Đóng"
                                style="position: absolute; top: 10px; right: 15px;">
                            <span aria-hidden="true" style="font-size: 2rem;">&times;</span>
                        </button>
                        <img id="modalImage" src="" class="img-fluid rounded"
                             style="max-height: 75vh; max-width: 100%; object-fit: contain;" alt="Zoom ảnh">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentStoreId = null;

        // DOM elements
        const storeListView = document.getElementById('storeListView');
        const storeDetailView = document.getElementById('storeDetailView');
        const backBtn = document.getElementById('backBtn');
        const pageTitle = document.querySelector('.page-title');

        $(document).ready(function () {
            // Thêm nút duyệt cửa hàng vào DataTable
            const browseButton = `
                        <a href="/Admin/Store/BrowseStore"
                           class="btn btn-danger ms-2"
                           style="min-width: 160px;">
                            <i class="mdi mdi-check-circle-outline mr-1"></i> Duyệt cửa hàng
                        </a>`;
            $('#productsTable_filter')
                .addClass('d-flex align-items-center justify-content-between')
                .append(browseButton);

            // Click vào 1 row cửa hàng
            $('.store-row').on('click', function (e) {
                if (!$(e.target).hasClass('clickable-image')) {
                    const storeId = $(this).data('store-id');
                    const storeName = $(this).data('name');
                    const storeOwner = $(this).data('owner');
                    const storeDate = $(this).data('date');
                    const storeStatus = $(this).data('status');
                    const storeImage = $(this).data('image');

                    showStoreDetail(storeId, storeName, storeOwner, storeDate, storeStatus, storeImage);
                }
            });

            // Nút quay lại
            $('#backBtn').on('click', function () {
                goBack();
            });

            // Zoom ảnh
            $('.clickable-image').on('click', function (e) {
                e.stopPropagation();
                $('#modalImage').attr('src', $(this).data('src'));
                $('#imageModal').modal('show');
            });

            $('.close').on('click', function () {
                $('#imageModal').modal('hide');
            });

            // Tab switching
            $('[data-bs-toggle="tab"]').on('click', function (e) {
                e.preventDefault();
                const target = $(this).data('bs-target');

                $('.nav-link').removeClass('active');
                $('.tab-pane').removeClass('show active');

                $(this).addClass('active');
                $(target).addClass('show active');
            });

            // Bổ sung: ESC key = quay lại
            $(document).on('keydown', function (e) {
                if (e.key === "Escape" && storeDetailView.style.display === 'block') {
                    goBack();
                }
            });
        });

        // Show store detail
        function showStoreDetail(storeId, storeName, storeOwner, storeDate, storeStatus, storeImage) {
            currentStoreId = storeId;

            storeListView.style.display = 'none';
            storeDetailView.style.display = 'block';
            backBtn.style.display = 'inline-block';
            pageTitle.textContent = `Chi tiết cửa hàng: ${storeName}`;

            document.getElementById('storeDetailName').textContent = storeName;
            document.getElementById('storeDetailOwner').textContent = storeOwner;
            document.getElementById('storeDetailDate').textContent = storeDate;

            // Badge status
            const statusBadge = document.getElementById('storeDetailStatus');
            if (storeStatus === 'Active') {
                statusBadge.className = 'badge badge-success fs-6';
                statusBadge.textContent = 'Đang hoạt động';
            } else {
                statusBadge.className = 'badge badge-warning fs-6';
                statusBadge.textContent = 'Chờ duyệt';
            }

            // Store image
            const storeDetailImage = document.getElementById('storeDetailImage');
            if (storeImage && storeImage.trim() !== '') {
                storeDetailImage.src = storeImage;
                storeDetailImage.style.display = 'block';
            } else {
                storeDetailImage.style.display = 'none';
            }

            // Gọi Ajax load data
            loadStoreData(storeId);
        }

        // Go back
        function goBack() {
            storeDetailView.style.display = 'none';
            storeListView.style.display = 'block';
            backBtn.style.display = 'none';
            pageTitle.textContent = 'Quản lý cửa hàng';
            currentStoreId = null;
        }

        // Load store data bằng Ajax
        function loadStoreData(storeId) {
            $.ajax({
                url: `/Admin/Store/GetDetail/${storeId}`,
                type: "GET",
                success: function (store) {
                    // === PRODUCTS ===
                    let productsHtml = "";
                    if (store.products && store.products.length > 0) {
                        store.products.forEach(p => {
                            let priceDisplay = p.minPrice && p.maxPrice && p.minPrice !== p.maxPrice
                                ? `${p.minPrice.toLocaleString()} - ${p.maxPrice.toLocaleString()} đ`
                                : `${(p.price || 0).toLocaleString()} đ`;

                            let statusHtml = "";
                            switch (p.status) {
                                case "Pending": statusHtml = '<span class="badge badge-warning">Chờ duyệt</span>'; break;
                                case "Approved": statusHtml = '<span class="badge badge-success">Đã duyệt</span>'; break;
                                default: statusHtml = '<span class="badge badge-secondary">Ẩn</span>'; break;
                            }

                            productsHtml += `
                                        <tr>
                                            <td>${p.id}</td>
                                            <td><img src="${p.image}" width="50" class="rounded"/></td>
                                            <td>${p.name}</td>
                                            <td>${priceDisplay}</td>
                                            <td>${p.stock}</td>
                                            <td>${p.category}</td>
                                            <td>${statusHtml}</td>
                                            <td><button class="btn btn-sm btn-outline-info">Chi tiết</button></td>
                                        </tr>`;
                        });
                    } else {
                        productsHtml = `<tr><td colspan="8" class="text-center text-muted">Chưa có sản phẩm nào</td></tr>`;
                    }
                    $("#productsTableBody").html(productsHtml);

                    // === ORDERS ===
                    let ordersHtml = "";
                    if (store.orders && store.orders.length > 0) {
                        store.orders.forEach(o => {
                            let statusHtml = "";
                            switch (o.status) {
                                case "ChoXuLy": statusHtml = '<span class="badge badge-warning">Chờ xử lý</span>'; break;
                                case "ChoLayHang": statusHtml = '<span class="badge badge-info">Chờ lấy hàng</span>'; break;
                                case "DangGiao": statusHtml = '<span class="badge badge-primary">Đang giao</span>'; break;
                                case "DaHoanThanh": statusHtml = '<span class="badge badge-success">Hoàn tất</span>'; break;
                                case "DaHuy": statusHtml = '<span class="badge badge-danger">Đã hủy</span>'; break;
                                default: statusHtml = '<span class="badge badge-secondary">Không rõ</span>'; break;
                            }

                            ordersHtml += `
                                        <tr>
                                            <td>${o.id}</td>
                                            <td>${o.customerName}</td>
                                            <td>${new Date(o.createAt).toLocaleDateString("vi-VN")}</td>
                                            <td>${o.totalAmount.toLocaleString()} đ</td>
                                            <td>${statusHtml}</td>
                                            <td><button class="btn btn-sm btn-outline-primary">Xem</button></td>
                                        </tr>`;
                        });
                    } else {
                        ordersHtml = `<tr><td colspan="6" class="text-center text-muted">Chưa có đơn hàng nào</td></tr>`;
                    }
                    $("#ordersTableBody").html(ordersHtml);

                    // === PAYMENT INFO ===
                    $("#bankName").text(store.bankName || "Chưa cập nhật");
                    $("#accountNumber").text(store.bankAccount || "Chưa cập nhật");
                    $("#accountHolder").text(store.accountHolder || "Chưa cập nhật");
                    $("#bankBranch").text(store.bankBranch || "Chưa cập nhật");

                    // === STATS ===
                    $("#productCount").text(store.products?.length || 0);
                    $("#orderCount").text(store.orders?.length || 0);
                    $("#revenueCount").text(
                        store.orders?.reduce((sum, o) => sum + o.totalAmount, 0).toLocaleString() || 0
                    );

                    // Reset về tab sản phẩm
                    $('.nav-link').removeClass('active');
                    $('.tab-pane').removeClass('show active');
                    $('#products-tab').addClass('active');
                    $('#products').addClass('show active');
                },
                error: function () {
                    console.error("Không load được chi tiết cửa hàng");
                }
            });
        }
    </script>

    <!-- Thêm modal này vào cuối trang Store management, trước tag </div> cuối -->
    <!-- Modal chi tiết sản phẩm -->
    <div class="modal fade" id="productDetailModal" tabindex="-1" role="dialog" aria-hidden="true" aria-labelledby="productDetailModalTitle" aria-describedby="productDetailModalDesc">
        <div class="modal-dialog modal-dialog-scrollable modal-xl" role="document">
            <div class="modal-content modal-product">
                <div class="modal-header bg-light">
                    <h5 class="modal-title" id="productDetailModalTitle">Chi tiết sản phẩm</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Đóng">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div id="productDetailModalBody" class="modal-body">
                    <p id="productDetailModalDesc" class="sr-only">Thông tin đầy đủ sản phẩm, thuộc tính và các biến thể.</p>
                    <div class="text-center py-4" id="productDetailLoading">
                        <div class="spinner-border" role="status" aria-label="Đang tải"></div>
                        <div class="mt-2">Đang tải...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .modal-product .product-hero img {
            max-height: 260px;
            object-fit: contain;
        }

        .modal-product figure {
            margin: 0;
        }

        .modal-product .thumbs img {
            width: 84px;
            height: 84px;
            object-fit: cover;
            border-radius: 8px;
        }

        .modal-product .meta dl {
            display: grid;
            grid-template-columns: 160px 1fr;
            gap: 8px 16px;
        }

        .modal-product .meta dt {
            font-weight: 600;
            color: #555;
        }

        .modal-product .meta dd {
            margin: 0;
        }

        .modal-product .badge-soft {
            background: #eef2ff;
            color: #3b82f6;
        }

        .modal-product .kv {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 999px;
            background: #f6f7f9;
            font-size: 12px;
        }

        .modal-product .table caption {
            caption-side: top;
            text-align: left;
            color: #6b7280;
        }
    </style>

    <script>
        // Thêm vào phần JavaScript của trang Store management

        // Function để hiển thị chi tiết sản phẩm
        function showProductDetail(productId) {
            const modal = $('#productDetailModal');
            const body = document.getElementById('productDetailModalBody');

            // Tạo loading element mới mỗi lần
            const loadingHTML = `
                <div class="text-center py-4" id="productDetailLoading">
                    <div class="spinner-border" role="status" aria-label="Đang tải"></div>
                    <div class="mt-2">Đang tải...</div>
                </div>
            `;

            // Reset UI với loading mới
            body.innerHTML = loadingHTML;

            // Mở modal
            modal.modal('show');

            // Gọi API để lấy chi tiết sản phẩm
            $.ajax({
                url: `/Admin/Product/GetProductDetail/${productId}`,
                type: 'GET',
                success: function (data) {
                    if (data.error) {
                        body.innerHTML = `<div class="alert alert-danger">${data.message || 'Có lỗi xảy ra'}</div>`;
                        return;
                    }

                    // Render nội dung chi tiết
                    body.innerHTML = `
                        <div class="row">
                            <div class="col-md-5 text-center product-hero mb-3">
                                <img src="${data.mainImage || '/images/no-image.png'}"
                                     alt="${data.name || 'Sản phẩm'}"
                                     class="img-fluid rounded shadow-sm"
                                     style="max-height:280px;object-fit:contain"/>
                            </div>
                            <div class="col-md-7">
                                <h4 class="mb-3">${data.name || 'Chưa có tên'}</h4>
                                <div class="meta mb-3">
                                    <dl>
                                        <dt>Xuất xứ</dt><dd>${data.placeoforigin || 'Chưa có'}</dd>
                                        <dt>Thương hiệu</dt><dd>${data.brand || 'Chưa có'}</dd>
                                        <dt>Tổng số lượng</dt><dd>${data.totalQuantity || 0}</dd>
                                        <dt>Giá</dt><dd>${data.price > 0 ? data.price.toLocaleString('vi-VN') + ' ₫' : 'Chưa có giá'}</dd>
                                        <dt>Ngày tạo</dt><dd>${data.createat || 'Chưa có'}</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
        <!-- Sau phần dl -->
        <div class="mt-3">
            <h6>Mô tả sản phẩm</h6>
            <div class="border p-3 rounded bg-light">
                ${data.description ?
                            data.description.replace(/\n/g, '<br>') :
                            '<em class="text-muted">Chưa có mô tả</em>'
                        }
            </div>
        </div>                        <div class="table-responsive">
                            <table class="table table-bordered table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>${data.variantName1 || 'Biến thể 1'}</th>
                                        <th>${data.variantName2 || 'Biến thể 2'}</th>
                                        <th>Giá vốn</th>
                                        <th>Giá bán</th>
                                        <th>Số lượng</th>
                                        <th>Khối lượng (g)</th>
                                        <th>Kích thước (cm)</th>
                                        <th>Ảnh</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.variants && data.variants.length > 0
                            ? data.variants.map(v => `
                                            <tr>
                                                <td>${v.variantValue1 || ''}</td>
                                                <td>${v.variantValue2 || ''}</td>
                                                <td>${(v.costPrice || 0).toLocaleString('vi-VN')} ₫</td>
                                                <td>${(v.price || 0).toLocaleString('vi-VN')} ₫</td>
                                                <td>${v.quantity || 0}</td>
                                                <td>${v.weight || 0}</td>
                                                <td>${(v.length || 0)} x ${(v.width || 0)} x ${(v.height || 0)}</td>
                                                <td>${v.image
                                    ? `<img src="${v.image}" class="img-thumbnail" style="width:50px;height:50px;object-fit:cover"/>`
                                    : 'Không có'}</td>
                                            </tr>
                                        `).join('')
                            : `<tr><td colspan="8" class="text-center text-muted">Không có biến thể</td></tr>`}
                                </tbody>
                            </table>
                        </div>
                    `;
                },
                error: function (xhr, status, error) {
                    console.error('Error loading product detail:', error);
                    body.innerHTML = `<div class="alert alert-danger">Lỗi tải dữ liệu chi tiết. Vui lòng thử lại.</div>`;
                }
            });
        }

        // Cập nhật function loadStoreData để thêm sự kiện click vào nút "Chi tiết"
        function loadStoreData(storeId) {
            $.ajax({
                url: `/Admin/Store/GetDetail/${storeId}`,
                type: "GET",
                success: function (store) {
                    // === PRODUCTS ===
                    let productsHtml = "";
                    if (store.products && store.products.length > 0) {
                        store.products.forEach(p => {
                            let priceDisplay = p.minPrice && p.maxPrice && p.minPrice !== p.maxPrice
                                ? `${p.minPrice.toLocaleString()} - ${p.maxPrice.toLocaleString()} đ`
                                : `${(p.price || 0).toLocaleString()} đ`;

                            let statusHtml = "";
                            switch (p.status) {
                                case "Pending": statusHtml = '<span class="badge badge-warning">Chờ duyệt</span>'; break;
                                case "Approved": statusHtml = '<span class="badge badge-success">Đã duyệt</span>'; break;
                                default: statusHtml = '<span class="badge badge-secondary">Ẩn</span>'; break;
                            }

                            productsHtml += `
                                <tr>
                                    <td>${p.id}</td>
                                    <td><img src="${p.image}" width="50" class="rounded"/></td>
                                    <td>${p.name}</td>
                                    <td>${priceDisplay}</td>
                                    <td>${p.stock}</td>
                                    <td>${p.category}</td>
                                    <td>${statusHtml}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-info btn-product-detail" data-product-id="${p.id}">
                                            <i class="mdi mdi-eye-outline"></i> Chi tiết
                                        </button>
                                    </td>
                                </tr>`;
                        });
                    } else {
                        productsHtml = `<tr><td colspan="8" class="text-center text-muted">Chưa có sản phẩm nào</td></tr>`;
                    }
                    $("#productsTableBody").html(productsHtml);

                    // Thêm sự kiện click cho các nút chi tiết sản phẩm
                    $('.btn-product-detail').on('click', function () {
                        const productId = $(this).data('product-id');
                        showProductDetail(productId);
                    });

                    // === ORDERS === (giữ nguyên code cũ)
                    let ordersHtml = "";
                    if (store.orders && store.orders.length > 0) {
                        store.orders.forEach(o => {
                            let statusHtml = "";
                            switch (o.status) {
                                case "ChoXuLy": statusHtml = '<span class="badge badge-warning">Chờ xử lý</span>'; break;
                                case "ChoLayHang": statusHtml = '<span class="badge badge-info">Chờ lấy hàng</span>'; break;
                                case "DangGiao": statusHtml = '<span class="badge badge-primary">Đang giao</span>'; break;
                                case "DaHoanThanh": statusHtml = '<span class="badge badge-success">Hoàn tất</span>'; break;
                                case "DaHuy": statusHtml = '<span class="badge badge-danger">Đã hủy</span>'; break;
                                default: statusHtml = '<span class="badge badge-secondary">Không rõ</span>'; break;
                            }

                            ordersHtml += `
                                <tr>
                                    <td>${o.id}</td>
                                    <td>${o.customerName}</td>
                                    <td>${new Date(o.createAt).toLocaleDateString("vi-VN")}</td>
                                    <td>${o.totalAmount.toLocaleString()} đ</td>
                                    <td>${statusHtml}</td>
                                    <td><button class="btn btn-sm btn-outline-primary">Xem</button></td>
                                </tr>`;
                        });
                    } else {
                        ordersHtml = `<tr><td colspan="6" class="text-center text-muted">Chưa có đơn hàng nào</td></tr>`;
                    }
                    $("#ordersTableBody").html(ordersHtml);

                    // === PAYMENT INFO === (giữ nguyên code cũ)
                    $("#bankName").text(store.bankName || "Chưa cập nhật");
                    $("#accountNumber").text(store.bankAccount || "Chưa cập nhật");
                    $("#accountHolder").text(store.accountHolder || "Chưa cập nhật");
                    $("#bankBranch").text(store.bankBranch || "Chưa cập nhật");

                    // === STATS === (giữ nguyên code cũ)
                    $("#productCount").text(store.products?.length || 0);
                    $("#orderCount").text(store.orders?.length || 0);
                    $("#revenueCount").text(
                        store.orders?.reduce((sum, o) => sum + o.totalAmount, 0).toLocaleString() || 0
                    );

                    // Reset về tab sản phẩm
                    $('.nav-link').removeClass('active');
                    $('.tab-pane').removeClass('show active');
                    $('#products-tab').addClass('active');
                    $('#products').addClass('show active');
                },
                error: function () {
                    console.error("Không load được chi tiết cửa hàng");
                }
            });
        }
    </script>
}