@model DATN_GO.Models.Vouchers
@{
    ViewData["Title"] = "Tạo Voucher Shop";
    var today = DateTime.Now.ToString("yyyy-MM-ddTHH:mm:ss");
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8 bg-white p-4 p-md-5 rounded shadow-sm border border-danger">
            <h4 class="mb-4 text-danger border-bottom pb-2">
                <i class="bi bi-ticket-perforated-fill me-2"></i> Tạo Voucher Shop
            </h4>

            <form asp-action="Create" method="post">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="Reduce" class="form-label">Giá trị giảm</label>
                        <input type="text" class="form-control" id="reduceDisplay" placeholder="VD: 20 hoặc 20000" />
                        <input asp-for="Reduce" type="hidden" id="Reduce" />
                        <small class="text-muted">Nếu chọn loại % thì tối đa 100%</small>
                        <span asp-validation-for="Reduce" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="Type" class="form-label">Loại voucher</label>
                        <select asp-for="Type" class="form-select" id="TypeSelect">
                            <option value="percent">Phần trăm (%)</option>
                            <option value="amount">Số tiền (₫)</option>
                        </select>
                        <span asp-validation-for="Type" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Đơn tối thiểu</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="minOrderDisplay" placeholder="VD: 100000" />
                            <span class="input-group-text">VND</span>
                        </div>
                        <input asp-for="MinOrder" type="hidden" id="MinOrder" />
                        <span asp-validation-for="MinOrder" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="Status" class="form-label">Trạng thái</label>
                        <select asp-for="Status" class="form-select">
                            <option value="active">Đang hoạt động</option>
                            <option value="inactive">Tạm ngưng</option>
                        </select>
                        <span asp-validation-for="Status" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="StartDate" class="form-label">Ngày bắt đầu</label>
                        <input asp-for="StartDate" type="datetime-local" class="form-control"
                               value="@DateTime.Today.ToString("yyyy-MM-ddT00:00:00")" />

                        <span asp-validation-for="StartDate" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="EndDate" class="form-label">Ngày kết thúc</label>
                        <input asp-for="EndDate" type="datetime-local" class="form-control"
                               value="@Model.EndDate.ToString("yyyy-MM-ddTHH:mm:ss")" />
                        <span asp-validation-for="EndDate" class="text-danger"></span>
                    </div>
                </div>

                <div class="mt-4">
                    <a asp-action="Voucher" class="btn btn-outline-secondary ms-2">Quay lại</a>
                    <button type="submit" class="btn btn-danger px-4">
                        <i class="bi bi-plus-circle me-1"></i> Tạo Voucher
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const minOrderDisplay = document.getElementById("minOrderDisplay");
    const minOrderHidden = document.getElementById("MinOrder");

    const reduceDisplay = document.getElementById("reduceDisplay");
    const reduceHidden = document.getElementById("Reduce");

    const typeSelect = document.getElementById("TypeSelect");

    // Format có dấu chấm
    function formatCurrencyInput(displayEl, hiddenEl) {
        displayEl.addEventListener("input", function () {
            let raw = this.value.replace(/\D/g, '');
            if (!raw) {
                hiddenEl.value = "";
                this.value = "";
                return;
            }
            hiddenEl.value = raw;
            this.value = Number(raw).toLocaleString("vi-VN");
        });
    }

    // Áp dụng cho MinOrder luôn
    formatCurrencyInput(minOrderDisplay, minOrderHidden);

    // Xử lý Reduce: nếu type = "amount" thì format
    reduceDisplay.addEventListener("input", () => {
        const type = typeSelect.value;
        if (type === "amount") {
            let raw = reduceDisplay.value.replace(/\D/g, '');
            if (!raw) {
                reduceHidden.value = "";
                reduceDisplay.value = "";
                return;
            }
            reduceHidden.value = raw;
            reduceDisplay.value = Number(raw).toLocaleString("vi-VN");
        } else {
            reduceHidden.value = reduceDisplay.value;
        }
    });

    // Nếu đổi loại voucher, reset format
    typeSelect.addEventListener("change", () => {
        reduceDisplay.value = "";
        reduceHidden.value = "";
    });

    // Gán lại giá trị cũ nếu reload
    window.addEventListener("DOMContentLoaded", () => {
        if (minOrderHidden.value)
            minOrderDisplay.value = Number(minOrderHidden.value).toLocaleString("vi-VN");

        if (reduceHidden.value && typeSelect.value === "amount")
            reduceDisplay.value = Number(reduceHidden.value).toLocaleString("vi-VN");
        else if (reduceHidden.value)
            reduceDisplay.value = reduceHidden.value;
    });
</script>
