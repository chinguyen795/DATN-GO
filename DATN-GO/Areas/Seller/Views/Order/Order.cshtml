@model List<DATN_GO.ViewModels.OrderViewModel>
@using DATN_GO.Models
@{
    var userIdStr = Context.Session.GetString("Id");  
    if (string.IsNullOrEmpty(userIdStr))
    {
        Context.Response.Redirect("https://localhost:7180/Login");  
    }
    else
    {
        var userId = int.Parse(userIdStr);
        <script>
            const userId = @userId; // inject sang JS
        </script>
    }
}
@functions {
    public string MapStatusToText(string status)
    {
        if (!Enum.TryParse<OrderStatus>(status, out var s))
            return "Không xác định";

        return s switch
        {
            OrderStatus.ChoXuLy => "Chờ xử lý",
            OrderStatus.ChoLayHang => "Chờ lấy hàng",
            OrderStatus.DangGiao => "Đang giao",
            OrderStatus.DaHoanThanh => "Hoàn thành",
            OrderStatus.DaHuy => "Đã hủy",
            _ => "Không xác định"
        };
    }

    public string MapStatusToBadgeClass(string status)
    {
        if (!Enum.TryParse<OrderStatus>(status, out var s))
            return "bg-secondary text-white";

        return s switch
        {
            OrderStatus.ChoXuLy => "bg-warning text-dark",
            OrderStatus.ChoLayHang => "bg-info text-white",
            OrderStatus.DangGiao => "bg-success text-white",
            OrderStatus.DaHoanThanh => "bg-primary text-white",
            OrderStatus.DaHuy => "bg-danger text-white",
            _ => "bg-secondary text-white"
        };
    }

    public string FormatCurrency(decimal amount)
    {
        return string.Format(new System.Globalization.CultureInfo("vi-VN"), "{0:C0}", amount);
    }

}

<style>
    /* Giảm kích thước chữ tiêu đề tab và padding để các tab nằm trên 1 hàng, không wrap chữ trong tab */
    .nav-pills .nav-link {
        font-size: 0.75rem;
        padding: 0.1rem 0.3rem;
        margin: 0 0.02rem;
        white-space: normal;
        display: inline-flex;
        align-items: center;
        gap: 0.15em;
        min-width: unset;
    }

        /* Giảm kích thước icon trong tab */
        .nav-pills .nav-link i {
            font-size: 1em;
        }

    /* Cho phép các tab tự động xuống dòng nếu không đủ chỗ, không có thanh cuộn ngang */
    #orderTabs {
        flex-wrap: wrap;
        gap: 0.02rem !important;
        overflow-x: unset;
    }

    /* Giảm kích thước chữ và padding của bảng để các tr cùng nằm trên 1 hàng */
    .table th,
    .table td {
        font-size: 0.8rem;
        padding-top: 0.1rem;
        padding-bottom: 0.1rem;
        vertical-align: middle;
        white-space: nowrap;
    }

    /* Badge và button nhỏ lại trong bảng */
    .table .badge,
    .table .btn {
        font-size: 0.75rem;
        padding: 0.2em 0.7em;
        line-height: 1.1;
    }

    /* Đảm bảo các badge không bị xuống dòng */
    .table .badge {
        white-space: nowrap;
    }

    /* Nếu cần, giảm margin/padding của ul.nav */
    .nav-pills.mb-3 {
        margin-bottom: 0.2rem !important;
    }
</style>
<div class="page-wrapper">

    <!-- Header -->
    <header class="main-header" id="header">
        <nav class="navbar navbar-expand-lg navbar-light" id="navbar">
            <!-- Sidebar toggle button -->
            <button id="sidebar-toggler" class="sidebar-toggle">
                <span class="sr-only">Toggle navigation</span>
            </button>

            <span class="page-title">ĐƠN HÀNG @userIdStr</span>


            <div class="navbar-right ">

                <ul class="nav navbar-nav">
                    <li class="custom-dropdown">
                        <a class="notify-toggler custom-dropdown-toggler" asp-controller="Notification" asp-action="Notification">
                            <i class="mdi mdi-bell-outline icon"></i>
                        </a>
                    </li>
                    <!-- User Account -->
                    <li class="dropdown user-menu">
                        <button class="dropdown-toggle nav-link" data-toggle="dropdown">
                            <img src="~/images/avt-user.jpg" alt="User Profile" width="32" height="32" style="object-fit: cover;" loading="lazy">
                            <span class="d-none d-lg-inline-block">@ViewBag.StoreName</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-right">
                            <li>
                                <a class="dropdown-link-item" asp-controller="Profile" asp-action="Index" asp-area="">
                                    <i class="mdi mdi-account-outline"></i>
                                    <span class="nav-text">Hồ Sơ</span>
                                </a>
                            </li>

                            <li class="dropdown-footer">
                                <a class="dropdown-link-item" href="/Seller/Order/Logout">
                                    <i class="mdi mdi-logout"></i> Đăng Xuất
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>

            </div>
        </nav>


    </header>

    <!-- ====================================
    ——— CONTENT WRAPPER
    ===================================== -->
    <div class="content-wrapper">
        <main class="py-5">
            <div class="container-fluid">
                
                <div class="modal fade" id="orderDetailsModal" tabindex="-1"
                     aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content rounded-3 shadow-lg">
                            <div class="modal-header text-white border-bottom border-danger">
                                <h5 class="modal-title fw-bold text-danger" id="orderDetailsModalLabel">
                                    Chi tiết
                                    đơn hàng
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-4">
                                <div class="row mb-4 gx-4">
                                    <div class="col-md-6 border-end pe-4">
                                        <p class="mb-2">
                                            <strong>Mã đơn:</strong> <span id="modalOrderId"
                                                                           class="text-danger fw-bold"></span>
                                        </p>
                                        <p class="mb-2">
                                            <strong>Khách hàng:</strong> <span id="modalCustomerName" class="text-danger fw-bold"></span>
                                        </p>
                                        <p class="mb-0">
                                            <strong>Ngày đặt:</strong> <span id="modalOrderDate"
                                                                             class="text-danger fw-bold"></span>
                                        </p>
                                    </div>
                                    <div class="col-md-6 ps-4">
                                        <p class="mb-2">
                                            <strong>Số lượng:</strong> <span id="modalQuantity"
                                                                             class="text-danger fw-bold"></span>
                                        </p>
                                        <p class="mb-2">
                                            <strong>Tổng tiền:</strong> <span id="modalTotalAmount"
                                                                              class="text-danger fw-bold"></span>
                                        </p>
                                        <p class="mb-0">
                                            <strong>Trạng thái:</strong> <span id="modalStatus"
                                                                               class="badge bg-danger text-white rounded-pill px-3 py-2"></span>
                                        </p>
                                    </div>
                                </div>
                                <div class="table-responsive border rounded-3 p-2 bg-white">
                                    <table class="table table-hover mb-0">
                                        <thead class="bg-light">
                                            <tr>
                                                <th scope="col">Sản phẩm</th>
                                                <th scope="col">Số lượng</th>
                                                <th scope="col">Đơn giá</th>
                                                <th scope="col">Thành tiền</th>
                                            </tr>
                                        </thead>
                                        <tbody id="modalOrderItems">
                                            <tr class="bg-light">
                                                <td>Sản phẩm A</td>
                                                <td>1</td>
                                                <td>500.000đ</td>
                                                <td>500.000đ</td>
                                            </tr>
                                            <tr class="bg-light">
                                                <td>Sản phẩm B</td>
                                                <td>1</td>
                                                <td>550.000đ</td>
                                                <td>550.000đ</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer justify-content-between p-3 border-top border-light">
                                <button type="button" class="btn btn-light rounded-pill px-4"
                                        data-bs-dismiss="modal">
                                    Đóng
                                </button>
                                <button type="button" class="btn btn-success rounded-pill px-4"
                                        id="btnUpdateStatus">
                                    Cập nhật
                                    trạng
                                    thái
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="card shadow-lg rounded-4">
                            <div class="card-header bg-white p-4 border-bottom-0">
                                <h4 class="mb-0 fw-bold">Quản Lý Đơn Hàng</h4>
                            </div>
                            <div class="card-body pt-0">
                                <ul class="nav nav-pills mb-3 px-2" id="orderTabs" role="tablist" style="gap: 0.5rem;">
                                    <li class="nav-item flex-fill text-center" role="presentation">
                                        <a class="nav-link active fw-bold py-2 px-2 text-black" id="allOrdersTab" data-bs-toggle="pill" href="#allOrders" role="tab" aria-controls="allOrders" aria-selected="true">
                                            <i class="mdi mdi-format-list-bulleted"></i> TẤT CẢ
                                        </a>
                                    </li>
                                    <li class="nav-item flex-fill text-center" role="presentation">
                                        <a class="nav-link fw-bold text-black py-2 px-2" id="pendingTab" data-bs-toggle="pill" href="#pendingOrders" role="tab" aria-controls="pendingOrders" aria-selected="false">
                                            <i class="mdi mdi-clock-outline"></i> CHỜ XỬ LÝ
                                        </a>
                                    </li>
                                    <li class="nav-item flex-fill text-center" role="presentation">
                                        <a class="nav-link fw-bold text-black py-2 px-2" id="readyTab" data-bs-toggle="pill" href="#readyOrders" role="tab" aria-controls="readyOrders" aria-selected="false">
                                            <i class="mdi mdi-package-variant"></i> CHỜ LẤY HÀNG
                                        </a>
                                    </li>
                                    <li class="nav-item flex-fill text-center" role="presentation">
                                        <a class="nav-link fw-bold text-black py-2 px-2" id="shippingTab" data-bs-toggle="pill" href="#shippingOrders" role="tab" aria-controls="shippingOrders" aria-selected="false">
                                            <i class="mdi mdi-truck-delivery"></i> ĐANG GIAO
                                        </a>
                                    </li>
                                    <li class="nav-item flex-fill text-center" role="presentation">
                                        <a class="nav-link fw-bold text-black py-2 px-2" id="completedTab" data-bs-toggle="pill" href="#completedOrders" role="tab" aria-controls="completedOrders" aria-selected="false">
                                            <i class="mdi mdi-check-circle-outline"></i> ĐÃ HOÀN THÀNH
                                        </a>
                                    </li>
                                    <li class="nav-item flex-fill text-center" role="presentation">
                                        <a class="nav-link fw-bold text-black py-2 px-2" id="cancelledTab" data-bs-toggle="pill" href="#cancelledOrders" role="tab" aria-controls="cancelledOrders" aria-selected="false">
                                            <i class="mdi mdi-close-circle-outline"></i> ĐÃ HỦY
                                        </a>
                                    </li>
                                </ul>

                                <div class="tab-content pt-3" id="orderTabsContent">
                                    <!-- TẤT CẢ -->
                                    <div class="tab-pane fade show active" id="allOrders" role="tabpanel" aria-labelledby="allOrdersTab">
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle mb-0">
                                                <thead class="bg-danger text-dark">
                                                    <tr>
                                                        <th scope="col" class="fw-bold text-dark">Mã Đơn</th>
                                                        <th scope="col" class="fw-bold text-dark">Khách Hàng</th>
                                                        <th scope="col" class="fw-bold text-dark">Số Lượng</th>
                                                        <th scope="col" class="fw-bold text-dark">Tổng Tiền</th>
                                                        <th scope="col" class="fw-bold text-dark">Ngày Đặt</th>
                                                        <th scope="col" class="fw-bold text-dark">Trạng Thái</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @if (Model?.Any() == true)
                                                    {
                                                        foreach (var order in Model)
                                                        {
                                                            <tr data-bs-toggle="modal" data-bs-target="#orderDetailsModal" data-order-id="@order.Id">
                                                                <td>#@order.Id</td>
                                                                <td>@order.CustomerName</td>
                                                                <td>@order.TotalQuantity món</td>
                                                                <td class="fw-semibold">@FormatCurrency(order.GrandTotal)</td>
                                                                <td>@order.CreatedAt.ToString("dd/MM/yyyy")</td>
                                                                <td>
                                                                    <span class="badge @MapStatusToBadgeClass(order.Status) px-3 py-2 rounded-pill">
                                                                        @MapStatusToText(order.Status)
                                                                    </span>
                                                                </td>
                                                            </tr>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <tr><td colspan="6" class="text-center">Không có đơn hàng</td></tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- CHỜ XỬ LÝ -->
                                    <div class="tab-pane fade" id="pendingOrders" role="tabpanel" aria-labelledby="pendingTab">
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle mb-0">
                                                <thead class="bg-danger text-dark">
                                                    <tr>
                                                        <th scope="col" class="fw-bold text-dark">Mã Đơn</th>
                                                        <th scope="col" class="fw-bold text-dark">Khách Hàng</th>
                                                        <th scope="col" class="fw-bold text-dark">Số Lượng</th>
                                                        <th scope="col" class="fw-bold text-dark">Tổng Tiền</th>
                                                        <th scope="col" class="fw-bold text-dark">Ngày Đặt</th>
                                                        <th scope="col" class="fw-bold text-dark">Thao Tác</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @if (Model != null && Model.Any(o => o.Status == OrderStatus.ChoXuLy.ToString()))
                                                    {
                                                        foreach (var order in Model.Where(o => o.Status == OrderStatus.ChoXuLy.ToString()))
                                                        {
                                                            <tr data-order-id="@order.Id">

                                                                <td>#@order.Id</td>
                                                                <td>@order.CustomerName</td>
                                                                <td>@order.TotalQuantity món</td>
                                                                <td class="fw-semibold">@FormatCurrency(order.TotalPrice)</td>
                                                                <td>@order.CreatedAt.ToString("dd/MM/yyyy")</td>
                                                                <td>
                                                                    <button class="btn btn-sm btn-success rounded-pill me-2" type="button">
                                                                        Xác nhận
                                                                    </button>
                                                                    <button class="btn btn-sm btn-danger rounded-pill" type="button" data-bs-toggle="modal" data-bs-target="#rejectOrderModal">
                                                                        Từ chối
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <tr><td colspan="6" class="text-center">Không có đơn hàng</td></tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- CHỜ LẤY HÀNG -->
                                    <div class="tab-pane fade" id="readyOrders" role="tabpanel" aria-labelledby="readyTab">
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle mb-0">
                                                <thead class="bg-danger text-dark">
                                                    <tr>
                                                        <th scope="col" class="fw-bold text-dark">Mã Đơn</th>
                                                        <th scope="col" class="fw-bold text-dark">Khách Hàng</th>
                                                        <th scope="col" class="fw-bold text-dark">Số Lượng</th>
                                                        <th scope="col" class="fw-bold text-dark">Tổng Tiền</th>
                                                        <th scope="col" class="fw-bold text-dark">Ngày Đặt</th>
                                                        <th scope="col" class="fw-bold text-dark">Trạng Thái</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @if (Model != null && Model.Any(o => o.Status == OrderStatus.ChoLayHang.ToString()))
                                                    {
                                                        foreach (var order in Model.Where(o => o.Status == OrderStatus.ChoLayHang.ToString()))
                                                        {
                                                            <tr data-bs-toggle="modal" data-bs-target="#orderDetailsModal" data-order-id="@order.Id">
                                                                <td>#@order.Id</td>
                                                                <td>@order.CustomerName</td>
                                                                <td>@order.TotalQuantity món</td>
                                                                <td class="fw-semibold">@FormatCurrency(order.TotalPrice)</td>
                                                                <td>@order.CreatedAt.ToString("dd/MM/yyyy")</td>
                                                                <td>
                                                                    <span class="badge @MapStatusToBadgeClass(order.Status) px-3 py-2 rounded-pill">@MapStatusToText(order.Status)</span>
                                                                </td>
                                                            </tr>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <tr><td colspan="6" class="text-center">Không có đơn hàng</td></tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- ĐANG GIAO -->
                                    <div class="tab-pane fade" id="shippingOrders" role="tabpanel" aria-labelledby="shippingTab">
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle mb-0">
                                                <thead class="bg-danger text-dark">
                                                    <tr>
                                                        <th scope="col" class="fw-bold text-dark">Mã Đơn</th>
                                                        <th scope="col" class="fw-bold text-dark">Khách Hàng</th>
                                                        <th scope="col" class="fw-bold text-dark">Số Lượng</th>
                                                        <th scope="col" class="fw-bold text-dark">Tổng Tiền</th>
                                                        <th scope="col" class="fw-bold text-dark">Ngày Đặt</th>
                                                        <th scope="col" class="fw-bold text-dark">Trạng Thái</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @if (Model != null && Model.Any(o => o.Status == OrderStatus.DangGiao.ToString()))
                                                    {
                                                        foreach (var order in Model.Where(o => o.Status == OrderStatus.DangGiao.ToString()))
                                                        {
                                                            <tr data-bs-toggle="modal" data-bs-target="#orderDetailsModal" data-order-id="@order.Id">
                                                                <td>#@order.Id</td>
                                                                <td>@order.CustomerName</td>
                                                                <td>@order.TotalQuantity món</td>
                                                                <td class="fw-semibold">@FormatCurrency(order.TotalPrice)</td>
                                                                <td>@order.CreatedAt.ToString("dd/MM/yyyy")</td>
                                                                <td>
                                                                    <span class="badge @MapStatusToBadgeClass(order.Status) px-3 py-2 rounded-pill">@MapStatusToText(order.Status)</span>
                                                                </td>
                                                            </tr>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <tr><td colspan="6" class="text-center">Không có đơn hàng</td></tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- ĐÃ HOÀN THÀNH -->
                                    <div class="tab-pane fade" id="completedOrders" role="tabpanel" aria-labelledby="completedTab">
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle mb-0">
                                                <thead class="bg-danger text-dark">
                                                    <tr>
                                                        <th scope="col" class="fw-bold text-dark">Mã Đơn</th>
                                                        <th scope="col" class="fw-bold text-dark">Khách Hàng</th>
                                                        <th scope="col" class="fw-bold text-dark">Số Lượng</th>
                                                        <th scope="col" class="fw-bold text-dark">Tổng Tiền</th>
                                                        <th scope="col" class="fw-bold text-dark">Ngày Đặt</th>
                                                        <th scope="col" class="fw-bold text-dark">Trạng Thái</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @if (Model != null && Model.Any(o => o.Status == OrderStatus.DaHoanThanh.ToString()))
                                                    {
                                                        foreach (var order in Model.Where(o => o.Status == OrderStatus.DaHoanThanh.ToString()))
                                                        {
                                                            <tr data-bs-toggle="modal" data-bs-target="#orderDetailsModal" data-order-id="@order.Id">
                                                                <td>#@order.Id</td>
                                                                <td>@order.CustomerName</td>
                                                                <td>@order.TotalQuantity món</td>
                                                                <td class="fw-semibold">@FormatCurrency(order.TotalPrice)</td>
                                                                <td>@order.CreatedAt.ToString("dd/MM/yyyy")</td>
                                                                <td>
                                                                    <span class="badge @MapStatusToBadgeClass(order.Status) px-3 py-2 rounded-pill">@MapStatusToText(order.Status)</span>
                                                                </td>
                                                            </tr>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <tr><td colspan="6" class="text-center">Không có đơn hàng</td></tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- ĐÃ HỦY -->
                                    <div class="tab-pane fade" id="cancelledOrders" role="tabpanel" aria-labelledby="cancelledTab">
                                        <div class="table-responsive">
                                            <table class="table table-hover align-middle mb-0">
                                                <thead class="bg-danger text-dark">
                                                    <tr>
                                                        <th scope="col" class="fw-bold text-dark">Mã Đơn</th>
                                                        <th scope="col" class="fw-bold text-dark">Khách Hàng</th>
                                                        <th scope="col" class="fw-bold text-dark">Số Lượng</th>
                                                        <th scope="col" class="fw-bold text-dark">Tổng Tiền</th>
                                                        <th scope="col" class="fw-bold text-dark">Ngày Đặt</th>
                                                        <th scope="col" class="fw-bold text-dark">Lý Do Hủy</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @if (Model != null && Model.Any(o => o.Status == OrderStatus.DaHuy.ToString()))
                                                    {
                                                        foreach (var order in Model.Where(o => o.Status == OrderStatus.DaHuy.ToString()))
                                                        {
                                                            <tr data-bs-toggle="modal" data-bs-target="#orderDetailsModal" data-order-id="@order.Id">
                                                                <td>#@order.Id</td>
                                                                <td>@order.CustomerName</td>
                                                                <td>@order.TotalQuantity món</td>
                                                                <td class="fw-semibold">@FormatCurrency(order.TotalPrice)</td>
                                                                <td>@order.CreatedAt.ToString("dd/MM/yyyy")</td>
                                                                <td>
                                                                    <span class="badge @MapStatusToBadgeClass(order.Status) px-3 py-2 rounded-pill">
                                                                        @MapStatusToText(order.Status)
                                                                    </span>
                                                                </td>
                                                            </tr>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <tr><td colspan="6" class="text-center">Không có đơn hàng</td></tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="col-lg-4">
                        <div class="card shadow-lg h-100 rounded-4">
                            <div class="card-header bg-white p-4 border-bottom-0">
                                <h4 class="mb-0 fw-bold">Phân Tích Doanh Số</h4>
                            </div>
                            <div class="card-body d-flex flex-column p-4">
                                <div class="mb-5">
                                    <label class="form-label small fw-semibold text-muted">Thời Gian</label>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <div class="input-group input-group-sm rounded-pill overflow-hidden shadow-sm d-flex align-items-center">
                                                <span class="input-group-text bg-danger text-white border-0 px-3 d-flex align-items-center">Từ</span>
                                                <input type="datetime-local"
                                                       class="form-control border-0 form-control-sm py-0"
                                                       style="height: 31px;" id="startDate" />
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="input-group input-group-sm rounded-pill overflow-hidden shadow-sm d-flex align-items-center">
                                                <span class="input-group-text bg-danger text-white border-0 px-3 d-flex align-items-center">Đến</span>
                                                <input type="datetime-local"
                                                       class="form-control border-0 form-control-sm py-0"
                                                       style="height: 31px;" id="endDate" />
                                            </div>
                                        </div>
                                        <div class="col-12 mt-3">
                                            <div class="dropdown">
                                                <button class="btn btn-outline-danger rounded-pill dropdown-toggle w-100 text-start"
                                                        type="button" id="quickDateSelectButton"
                                                        data-bs-toggle="dropdown" aria-expanded="false" style="text-transform: capitalize;">
                                                    Chọn nhanh
                                                </button>
                                                <ul class="dropdown-menu w-100"
                                                    aria-labelledby="quickDateSelectButton">
                                                    <li>
                                                        <a class="dropdown-item" href="#" data-value="today">
                                                            Hôm
                                                            Nay
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item" href="#"
                                                           data-value="yesterday">Hôm Qua</a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item" href="#"
                                                           data-value="thisWeek">Tuần Này</a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item" href="#"
                                                           data-value="lastWeek">Tuần Trước</a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item" href="#"
                                                           data-value="thisMonth">Tháng Này</a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item" href="#"
                                                           data-value="lastMonth">Tháng Trước</a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>

                                    </div>
                                </div>

                                <div class="row g-4 flex-grow-1" style="row-gap: 1rem;">
                                    <div class="col-md-6">
                                        <div class="card bg-danger text-white h-100 rounded-3 shadow-sm">
                                            <div class="d-flex flex-column justify-content-between align-items-center h-100 p-4">
                                                <div class="bg-white rounded-circle mb-3 d-flex justify-content-center align-items-center"
                                                     style="width: 56px; height: 56px;">
                                                    <i class="bi bi-cart-check text-danger fs-3"></i>
                                                </div>
                                                <div class="text-center">
                                                    <h3 class="display-6 fw-bold mb-1" id="totalOrders">0</h3>
                                                    <p class="mb-2 fw-light">Tổng Đơn hàng</p>
                                                    <div class="progress bg-white"
                                                         style="height: 8px; border-radius: 5px;">
                                                        <div class="progress-bar bg-white" role="progressbar"
                                                             style="width: 60%;" aria-valuenow="60"
                                                             aria-valuemin="0" aria-valuemax="100"></div>
                                                    </div>
                                                    <small id="totalOrdersChange" class="mt-2 d-block fw-light">0% so với kỳ trước</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="card bg-warning text-white h-100 rounded-3 shadow-sm">
                                            <div class="d-flex flex-column justify-content-between align-items-center h-100 p-4">
                                                <div class="bg-white rounded-circle mb-3 d-flex justify-content-center align-items-center"
                                                     style="width: 56px; height: 56px;">
                                                    <i class="bi bi-hourglass-split text-warning fs-3"></i>
                                                </div>
                                                <div class="text-center">
                                                    <h3 class="display-6 fw-bold mb-1" id="pendingOrders">0</h3>
                                                    <p class="mb-2 fw-light">Chờ xử lý Hàng</p>
                                                    <div class="progress bg-white"
                                                         style="height: 8px; border-radius: 5px;">
                                                        <div class="progress-bar bg-white" role="progressbar"
                                                             style="width: 45%;" aria-valuenow="45"
                                                             aria-valuemin="0" aria-valuemax="100"></div>
                                                    </div>
                                                    <small id="pendingOrdersChange" class="mt-2 d-block fw-light">0% so với kỳ trước</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="card bg-success text-white h-100 rounded-3 shadow-sm">
                                            <div class="d-flex flex-column justify-content-between align-items-center h-100 p-4">
                                                <div class="bg-white rounded-circle mb-3 d-flex justify-content-center align-items-center"
                                                     style="width: 56px; height: 56px;">
                                                    <i class="bi bi-truck text-success fs-3"></i>
                                                </div>
                                                <div class="text-center">
                                                    <h3 class="display-6 fw-bold mb-1" id="shippingOrders">0</h3>
                                                    <p class="mb-2 fw-light">Đang giao hàng</p>
                                                    <div class="progress bg-white"
                                                         style="height: 8px; border-radius: 5px;">
                                                        <div class="progress-bar bg-white" role="progressbar"
                                                             style="width: 75%;" aria-valuenow="75"
                                                             aria-valuemin="0" aria-valuemax="100"></div>
                                                    </div>
                                                    <small id="shippingOrdersChange" class="mt-2 d-block fw-light">0% so với kỳ trước</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="card bg-primary text-white h-100 rounded-3 shadow-sm">
                                            <div class="d-flex flex-column justify-content-between align-items-center h-100 p-4">
                                                <div class="bg-white rounded-circle mb-3 d-flex justify-content-center align-items-center"
                                                     style="width: 56px; height: 56px;">
                                                    <i class="bi bi-check-circle text-primary fs-3"></i>
                                                </div>
                                                <div class="text-center">
                                                    <h3 class="display-6 fw-bold mb-1" id="completedOrders">0</h3>
                                                    <p class="mb-2 fw-light">Đã hoàn thành</p>
                                                    <div class="progress bg-white"
                                                         style="height: 8px; border-radius: 5px;">
                                                        <div class="progress-bar bg-white" role="progressbar"
                                                             style="width: 85%;" aria-valuenow="85"
                                                             aria-valuemin="0" aria-valuemax="100"></div>
                                                    </div>
                                                    <small id="completedOrdersChange" class="mt-2 d-block fw-light">0% so với kỳ trước</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>
</div>
<!-- Modal Xác nhận đơn hàng -->
<div class="modal fade" id="confirmOrderModal" tabindex="-1" role="dialog" aria-labelledby="confirmOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success">
                <h5 class="modal-title text-white" id="confirmOrderModalLabel">Xác nhận đơn hàng</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Bạn có chắc chắn muốn xác nhận đơn hàng này không?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light btn-pill" data-bs-dismiss="modal">Đóng</button>
                <button type="button" id="btnConfirmAccept" class="btn btn-success btn-pill">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Từ chối đơn hàng -->
<div class="modal fade" id="rejectOrderModal" tabindex="-1" role="dialog" aria-labelledby="rejectOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger">
                <h5 class="modal-title text-white" id="rejectOrderModalLabel">Từ chối đơn hàng</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Bạn có chắc chắn muốn từ chối đơn hàng này không?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light btn-pill" data-bs-dismiss="modal">Đóng</button>
                <button type="button" id="btnConfirmReject" class="btn btn-danger btn-pill">Xác nhận từ chối</button>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE_URL = 'https://localhost:7096/api'; // Khai báo duy nhất 1 lần
    let productTotal = 0;

    document.addEventListener('DOMContentLoaded', function () {
        // --- Xử lý style tab ---
        const originalColors = {};
        document.querySelectorAll('#orderTabs .nav-link').forEach(tab => {
            originalColors[tab.id] = Array.from(tab.classList).find(cls => cls.startsWith('text-'));
        });

        document.querySelectorAll('#orderTabs .nav-link').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function () {
                document.querySelectorAll('#orderTabs .nav-link').forEach(t => {
                    t.classList.remove('bg-danger', 'text-white');
                    if (originalColors[t.id]) t.classList.add(originalColors[t.id]);
                });
                this.classList.remove(originalColors[this.id]);
                this.classList.add('bg-danger', 'bg-opacity-25', 'text-white');
            });
        });

        const activeTab = document.querySelector('#orderTabs .nav-link.active');
        if (activeTab) {
            activeTab.classList.remove(originalColors[activeTab.id]);
            activeTab.classList.add('bg-danger', 'bg-opacity-25', 'text-white');
        }

        // --- Modal chi tiết đơn hàng ---
        const orderDetailsModal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));

        function formatCurrency(value) {
            if (typeof value !== 'number') return value;
            return value.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
        }

        function mapStatus(status) {
            const map = {
                'ChoXuLy': ['Chờ xử lý', 'bg-warning text-dark'],
                'ChoLayHang': ['Chờ lấy hàng', 'bg-info text-white'],
                'DangGiao': ['Đang giao', 'bg-success text-white'],
                'DaHoanThanh': ['Hoàn thành', 'bg-primary text-white'],
                'DaHuy': ['Đã hủy', 'bg-danger text-white']
            };
            return map[status] || ['Không xác định', 'bg-secondary text-white'];
        }

        document.querySelectorAll('tr[data-order-id]').forEach(row => {
            row.addEventListener('click', async (event) => {
                if (event.target.closest('td:last-child')) return;

                const orderId = row.getAttribute('data-order-id');
                if (!orderId) return;

                try {
                    const resp = await fetch(`${API_BASE_URL}/orders/${orderId}`);
                    if (!resp.ok) throw new Error('Không lấy được thông tin đơn hàng');
                    const order = await resp.json();

                    document.getElementById('modalOrderId').textContent = `#${order.id}`;
                    document.getElementById('modalCustomerName').textContent = order.customerName || 'N/A';
                    const createdAt = new Date(order.createdAt);
                    document.getElementById('modalOrderDate').textContent = createdAt.toLocaleDateString('vi-VN');
                    document.getElementById('modalQuantity').textContent = `${order.totalQuantity} món`;
                    document.getElementById('modalTotalAmount').textContent = formatCurrency(order.grandTotal);

                    const [statusText, statusClass] = mapStatus(order.status);
                    const modalStatus = document.getElementById('modalStatus');
                    modalStatus.textContent = statusText;
                    modalStatus.className = '';
                    modalStatus.classList.add('badge', ...statusClass.split(' '), 'rounded-pill', 'px-3', 'py-2');

                    const tbody = document.getElementById('modalOrderItems');
                    tbody.innerHTML = '';

                    if (order.orderDetails && order.orderDetails.length > 0) {
                            order.orderDetails.forEach(item => {
        const tr2 = document.createElement('tr');
        tr2.classList.add('bg-light');
        const totalPrice = item.quantity * item.unitPrice;
        productTotal += totalPrice;

        tr2.innerHTML = `
            <td>${item.productName || ''}</td>
            <td>${item.quantity}</td>
            <td>${formatCurrency(item.unitPrice)}</td>
            <td>${formatCurrency(totalPrice)}</td>
        `;
        tbody.appendChild(tr2);
    });

                    } else {
                        tbody.innerHTML = `<tr><td colspan="4" class="text-center">Không có sản phẩm</td></tr>`;
                    }

                    orderDetailsModal.show();

                } catch (error) {
                    alert(error.message);
                }
            });
        });

        // --- Modal Xác nhận đơn hàng ---
        const confirmOrderModalEl = document.getElementById('confirmOrderModal');
        const confirmOrderModal = new bootstrap.Modal(confirmOrderModalEl);

        // --- Modal Từ chối đơn hàng ---
        const rejectOrderModalEl = document.getElementById('rejectOrderModal');
        const rejectOrderModal = new bootstrap.Modal(rejectOrderModalEl);

        // Hàm cập nhật trạng thái chung
        async function updateOrderStatus(orderId, newStatus) {
            try {
                const response = await fetch(`${API_BASE_URL}/orders/updatestatus/${orderId}?status=${newStatus}`, {
                    method: 'PATCH'
                });
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || 'Cập nhật trạng thái thất bại');
                }
                alert('Cập nhật trạng thái thành công!');
                location.reload(); // Reload trang sau khi thành công
            } catch (error) {
                alert('Lỗi: ' + error.message);
            }
        }

        // Gán sự kiện mở modal xác nhận khi bấm nút xác nhận (btn-success) trên bảng
        document.querySelectorAll('.btn-success').forEach(button => {
            button.addEventListener('click', function (e) {
                e.stopPropagation();
                const tr = this.closest('tr');
                if (!tr) return;
                const orderId = tr.getAttribute('data-order-id');
                if (!orderId) return;

                confirmOrderModalEl.dataset.orderId = orderId; // Lưu orderId vào dataset của modal
                confirmOrderModal.show();
            });
        });

        // Xử lý nút xác nhận trong modal xác nhận đơn hàng
        document.getElementById('btnConfirmAccept').addEventListener('click', function () {
            const orderId = confirmOrderModalEl.dataset.orderId;
            if (!orderId) {
                alert('Không xác định được đơn hàng');
                return;
            }
            updateOrderStatus(orderId, 'ChoLayHang'); // Gọi hàm cập nhật trạng thái
            confirmOrderModal.hide(); // Đóng modal
        });

        // Gán sự kiện mở modal từ chối khi bấm nút từ chối (btn-danger) trên bảng
        document.querySelectorAll('.btn-danger').forEach(button => {
            button.addEventListener('click', function (e) {
                e.stopPropagation();
                const tr = this.closest('tr');
                if (!tr) return;
                const orderId = tr.getAttribute('data-order-id');
                if (!orderId) return;

                rejectOrderModalEl.dataset.orderId = orderId; // Lưu orderId vào dataset của modal
                rejectOrderModal.show();
            });
        });
         
        document.getElementById('btnConfirmReject').addEventListener('click', function () {
            const orderId = rejectOrderModalEl.dataset.orderId;
            if (!orderId) {
                alert('Không xác định được đơn hàng');
                return;
            }
            updateOrderStatus(orderId, 'DaHuy'); // Gọi hàm cập nhật trạng thái
            rejectOrderModal.hide(); // Đóng modal
        });
        // --- PHẦN QUẢN LÝ THỐNG KÊ ---
        const userId = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(userIdStr));

        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const quickDateSelectButton = document.getElementById('quickDateSelectButton');
        const dropdownItems = document.querySelectorAll('#quickDateSelectButton + .dropdown-menu .dropdown-item');

        function formatNumber(num) {
            return num.toLocaleString('vi-VN');
        }

        function formatPercentChange(value) {
            const sign = value > 0 ? '+' : value < 0 ? '-' : '';
            return `${sign}${Math.abs(value).toFixed(1)}%`;
        }

        async function fetchStatistics(start, end) {
            try {
                let url = `${API_BASE_URL}/orders/statistics-by-user/${userId}`;
                const params = [];
                if (start) params.push(`start=${encodeURIComponent(start.toISOString())}`);
                if (end) params.push(`end=${encodeURIComponent(end.toISOString())}`);
                if (params.length > 0) url += "?" + params.join("&");

                const response = await fetch(url);
                if (!response.ok) throw new Error(await response.text() || 'Lỗi lấy dữ liệu thống kê');

                const json = await response.json();
                console.log("📊 API response:", json);
                return json;
            } catch (error) {
                alert('Không tải được số liệu: ' + error.message);
                return null;
            }
        }

        function updateStatisticsUI(data) {
            if (!data) return;
            const cardMap = {
                totalOrders: '.card.bg-danger',
                pendingOrders: '.card.bg-warning',
                shippingOrders: '.card.bg-success',
                completedOrders: '.card.bg-primary'
            };

            for (const key in cardMap) {
                if (typeof data[key] !== 'undefined') {
                    const card = document.querySelector(cardMap[key]);
                    if (!card) continue;

                    const h3 = card.querySelector('h3.display-6');
                    if (h3) h3.textContent = formatNumber(data[key] || 0);

                    const small = card.querySelector('small');
                    const percentKey = key + 'PercentChange';
                    if (small) {
                        if (typeof data[percentKey] !== 'undefined') {
                            let color = 'text-muted';
                            if (data[percentKey] > 0) color = 'text-success';
                            else if (data[percentKey] < 0) color = 'text-danger';
                            small.innerHTML = `<span class="${color}">${formatPercentChange(data[percentKey])}</span> so với kỳ trước`;
                        } else {
                            small.textContent = '';
                        }
                    }
                }
            }
        }

        function handleQuickDateSelect(value) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            let start, end;
            switch (value) {
                case 'today':
                    start = today;
                    end = new Date(today.getTime() + 24 * 60 * 60 * 1000);
                    break;
                case 'yesterday':
                    start = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                    end = today;
                    break;
                case 'thisWeek':
                    start = new Date(today);
                    start.setDate(today.getDate() - today.getDay());
                    end = new Date(today.getTime() + 24 * 60 * 60 * 1000);
                    break;
                case 'lastWeek':
                    start = new Date(today);
                    start.setDate(today.getDate() - today.getDay() - 7);
                    end = new Date(start);
                    end.setDate(start.getDate() + 7);
                    break;
                case 'thisMonth':
                    start = new Date(today.getFullYear(), today.getMonth(), 1);
                    end = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                    break;
                case 'lastMonth':
                    start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    end = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
                default:
                    start = null; end = null;
            }
            const toInput = d =>
                d.getFullYear() + '-' +
                String(d.getMonth() + 1).padStart(2, '0') + '-' +
                String(d.getDate()).padStart(2, '0') + 'T' +
                String(d.getHours()).padStart(2, '0') + ':' +
                String(d.getMinutes()).padStart(2, '0');
            if (start && end) {
                startDateInput.value = toInput(start);
                endDateInput.value = toInput(end);
            } else {
                startDateInput.value = '';
                endDateInput.value = '';
            }
            const label = document.querySelector(`[data-value="${value}"]`);
            if (label) quickDateSelectButton.textContent = label.textContent.trim();
            loadStatistics();
        }

        async function loadStatistics() {
            const start = startDateInput.value ? new Date(startDateInput.value) : null;
            const end = endDateInput.value ? new Date(endDateInput.value) : null;
            const data = await fetchStatistics(start, end);
            updateStatisticsUI(data);
        }

        startDateInput.addEventListener('change', loadStatistics);
        endDateInput.addEventListener('change', loadStatistics);
        dropdownItems.forEach(item => {
            item.addEventListener('click', function (e) {
                e.preventDefault();
                handleQuickDateSelect(this.getAttribute('data-value'));
            });
        });

        loadStatistics();
    });
</script>
 